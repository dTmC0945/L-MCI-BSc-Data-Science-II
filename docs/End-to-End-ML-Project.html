<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Code for Machine Learning and Data Science II End to End ML Project</title>
<meta name="author" content="Daniel McGuiness" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" href="config/style.css">
<script type="text/javascript"  src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="config/test.js">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
// @license-end
</script>

<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href=""> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Code for Machine Learning and Data Science II End to End ML Project</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2f0bf70">Introduction</a>
<ul>
<li><a href="#org8a2fd82">Preamble</a></li>
<li><a href="#orgaefd400">Download Initial Data</a></li>
<li><a href="#org9e77e09">Create a Set for Testing</a></li>
</ul>
</li>
<li><a href="#org6198fb9">Discover and Visualize the Data to Gain Insights</a>
<ul>
<li><a href="#orgc6578a0">Visualising Geographical Data</a></li>
<li><a href="#orgf40f08c">Looking for Correlations</a></li>
<li><a href="#org0b1a16e">Experimenting with Attribute Combinations</a></li>
</ul>
</li>
<li><a href="#orgee8751a">Prepare the Data for Machine Learning Algorithms</a>
<ul>
<li><a href="#org07d80f2">Data Cleaning</a></li>
<li><a href="#org628048a">Handling Text and Categorical Attributes</a></li>
<li><a href="#org2ccd232">Feature Scaling</a></li>
<li><a href="#org4526581">Custom Transformers</a></li>
<li><a href="#org4182010">Transformation Pipelines</a></li>
</ul>
</li>
<li><a href="#org7afd8db">Select and Train a Model</a>
<ul>
<li><a href="#orgd8aecd0">Training and Evaluating on the Training Set</a></li>
<li><a href="#orgde567af">Better Evaluation using Cross-Validation</a></li>
</ul>
</li>
<li><a href="#org9f5333d">Fine-Tuning the Model</a>
<ul>
<li><a href="#org0ea896b">Using Grid Search</a></li>
<li><a href="#org231f28e">Randomised Search</a></li>
<li><a href="#orgd6cdd18">Analyse the Best Models and Errors</a></li>
<li><a href="#org5006d1d">Evaluate using the Test Set</a></li>
<li><a href="#org3dcab0f">Saving the Model</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
These are the code snippets used in <span class="Hlight">End to End ML Project</span>
part of <span class="Hlight">Machine Learning and Data Science II</span>.
</p>

<div id="outline-container-org2f0bf70" class="outline-2">
<h2 id="org2f0bf70">Introduction</h2>
<div class="outline-text-2" id="text-org2f0bf70">
</div>
<div id="outline-container-org8a2fd82" class="outline-3">
<h3 id="org8a2fd82">Preamble</h3>
<div class="outline-text-3" id="text-org8a2fd82">
<div class="org-src-container">
<pre class="src src-python" id="org425a3a6"><span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-keyword">import</span> ChalcedonPy <span class="org-keyword">as</span> cp

<span class="org-comment-delimiter"># </span><span class="org-comment">Initialise ChalcedonPy</span>
cp.init<span class="org-rainbow-delimiters-depth-1">(</span>save_path<span class="org-operator">=</span><span class="org-string">"End-to-End-ML-Project"</span>,
        display_mode<span class="org-operator">=</span><span class="org-string">"web"</span><span class="org-rainbow-delimiters-depth-1">)</span> 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaefd400" class="outline-3">
<h3 id="orgaefd400">Download Initial Data</h3>
<div class="outline-text-3" id="text-orgaefd400">
<p>
First lets load the necessary modules for downloading the data so we
can work on it.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga2d190c"><span class="org-keyword">from</span> pathlib <span class="org-keyword">import</span> Path
<span class="org-keyword">import</span> pandas <span class="org-keyword">as</span> pd <span class="org-comment-delimiter"># </span><span class="org-comment">for dataframes</span>
<span class="org-keyword">import</span> tarfile <span class="org-comment-delimiter"># </span><span class="org-comment">read/write tar files</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">to access and download data from web</span>
<span class="org-keyword">import</span> urllib.request
<span class="org-keyword">from</span> tabulate <span class="org-keyword">import</span> tabulate <span class="org-comment-delimiter"># </span><span class="org-comment">for table printing</span>
</pre>
</div>

<p>
Define a function called <span class="Code">load_housing_data()</span> to access and
download the data, finally returning a read of it using pandas.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgfa9037a"><span class="org-keyword">def</span> <span class="org-function-name">load_housing_data</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">path to save the file</span>
    <span class="org-variable-name">tarball_path</span> <span class="org-operator">=</span> Path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"datasets/housing.tgz"</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">check if the path exists, if not create one</span>

    <span class="org-keyword">if</span> <span class="org-keyword">not</span> tarball_path.is_file<span class="org-rainbow-delimiters-depth-1">()</span>:
        Path<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"datasets"</span><span class="org-rainbow-delimiters-depth-1">)</span>.mkdir<span class="org-rainbow-delimiters-depth-1">(</span>parents<span class="org-operator">=</span><span class="org-constant">True</span>, exist_ok<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">url</span> <span class="org-operator">=</span> <span class="org-string">"https://github.com/dTmC0945/L-MCI-BSc-Data-Science-II/raw/main/data/housing.tgz"</span>
        urllib.request.urlretrieve<span class="org-rainbow-delimiters-depth-1">(</span>url, tarball_path<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">with</span> tarfile.<span class="org-builtin">open</span><span class="org-rainbow-delimiters-depth-1">(</span>tarball_path<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">as</span> housing_tarball:
            housing_tarball.extractall<span class="org-rainbow-delimiters-depth-1">(</span>path<span class="org-operator">=</span><span class="org-string">"datasets"</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> pd.read_csv<span class="org-rainbow-delimiters-depth-1">(</span>Path<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"datasets/housing/housing.csv"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now read the data and assign it to the value <span class="Code">housing</span>.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org60213dc"><span class="org-variable-name">housing</span> <span class="org-operator">=</span> load_housing_data<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<p>
Let's have a look at the data
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb4156d6"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing.head<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org19797b7">
   longitude  latitude  ...  median_house_value  ocean_proximity
0    -122.23     37.88  ...            452600.0         NEAR BAY
1    -122.22     37.86  ...            358500.0         NEAR BAY
2    -122.24     37.85  ...            352100.0         NEAR BAY
3    -122.25     37.85  ...            341300.0         NEAR BAY
4    -122.25     37.85  ...            342200.0         NEAR BAY
[5 rows x 10 columns]
</pre>

<p>
Each row represents one district.
</p>

<p>
There are 10 attributes
</p>

<ul class="org-ul">
<li>longitude,</li>
<li>latitude,</li>
<li>housing<sub>median</sub><sub>age</sub>,</li>
<li>total<sub>rooms</sub>,</li>
<li>total<sub>bed</sub> rooms,</li>
<li>population,</li>
<li>households,</li>
<li>median<sub>income</sub>,</li>
<li>median<sub>house</sub><sub>value</sub>,</li>
<li>and ocean<sub>proximity</sub>.</li>
</ul>

<p>
To get more information about the data use the <span class="Code">info()</span> method.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb018806"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing.info<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc9d536b">
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 20640 entries, 0 to 20639
Data columns (total 10 columns):
 #   Column              Non-Null Count  Dtype  
---  ------              --------------  -----  
 0   longitude           20640 non-null  float64
 1   latitude            20640 non-null  float64
 2   housing_median_age  20640 non-null  float64
 3   total_rooms         20640 non-null  float64
 4   total_bedrooms      20433 non-null  float64
 5   population          20640 non-null  float64
 6   households          20640 non-null  float64
 7   median_income       20640 non-null  float64
 8   median_house_value  20640 non-null  float64
 9   ocean_proximity     20640 non-null  object 
dtypes: float64(9), object(1)
memory usage: 1.6+ MB
None
</pre>

<p>
There seems to be some repetition on the <span class="Code">ocean_proximity</span> parameters.
Let's have a bit more look into the data.
</p>

<p>
To get more information on it use the <span class="Code">value_counts()</span> method.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9dc5d0f"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"ocean_proximity"</span><span class="org-rainbow-delimiters-depth-2">]</span>.value_counts<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc4ee79f">
ocean_proximity
&lt;1H OCEAN     9136
INLAND        6551
NEAR OCEAN    2658
NEAR BAY      2290
ISLAND           5
Name: count, dtype: int64
</pre>

<p>
Time to look at the the other fields using the <span class="Code">describe()</span> method which
shows their numerical attributes.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org2a1ad02"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing.describe<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc8146ae">
&lt;bound method NDFrame.describe of        longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income  median_house_value ocean_proximity
0        -122.23     37.88                41.0        880.0           129.0       322.0       126.0         8.3252            452600.0        NEAR BAY
1        -122.22     37.86                21.0       7099.0          1106.0      2401.0      1138.0         8.3014            358500.0        NEAR BAY
2        -122.24     37.85                52.0       1467.0           190.0       496.0       177.0         7.2574            352100.0        NEAR BAY
3        -122.25     37.85                52.0       1274.0           235.0       558.0       219.0         5.6431            341300.0        NEAR BAY
4        -122.25     37.85                52.0       1627.0           280.0       565.0       259.0         3.8462            342200.0        NEAR BAY
...          ...       ...                 ...          ...             ...         ...         ...            ...                 ...             ...
20635    -121.09     39.48                25.0       1665.0           374.0       845.0       330.0         1.5603             78100.0          INLAND
20636    -121.21     39.49                18.0        697.0           150.0       356.0       114.0         2.5568             77100.0          INLAND
20637    -121.22     39.43                17.0       2254.0           485.0      1007.0       433.0         1.7000             92300.0          INLAND
20638    -121.32     39.43                18.0       1860.0           409.0       741.0       349.0         1.8672             84700.0          INLAND
20639    -121.24     39.37                16.0       2785.0           616.0      1387.0       530.0         2.3886             89400.0          INLAND
[20640 rows x 10 columns]&gt;
</pre>

<p>
Allows the pretty print of the results.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org72a7065"><span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt

housing.hist<span class="org-rainbow-delimiters-depth-1">(</span>bins<span class="org-operator">=</span>50,  figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>12, 8<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"attribute-histogram-plots"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="orgc79dc56" class="figure">
<p><img src="images/End-to-End-ML-Project/attribute-histogram-plots.png" alt="attribute-histogram-plots.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org9e77e09" class="outline-3">
<h3 id="org9e77e09">Create a Set for Testing</h3>
<div class="outline-text-3" id="text-org9e77e09">
<div class="org-src-container">
<pre class="src src-python" id="org6da2771"><span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np

<span class="org-comment-delimiter"># </span><span class="org-comment">Define a function to shuffle and split data</span>
<span class="org-keyword">def</span> <span class="org-function-name">shuffle_and_split_data</span><span class="org-rainbow-delimiters-depth-1">(</span>data, test_ratio<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">shuffled_indices</span> <span class="org-operator">=</span> np.random.permutation<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">test_set_size</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">*</span> test_ratio<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">test_indices</span> <span class="org-operator">=</span> shuffled_indices<span class="org-rainbow-delimiters-depth-1">[</span>:test_set_size<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-variable-name">train_indices</span> <span class="org-operator">=</span> shuffled_indices<span class="org-rainbow-delimiters-depth-1">[</span>test_set_size:<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-keyword">return</span> data.iloc<span class="org-rainbow-delimiters-depth-1">[</span>train_indices<span class="org-rainbow-delimiters-depth-1">]</span>, data.iloc<span class="org-rainbow-delimiters-depth-1">[</span>test_indices<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>


<p>
To use the data we can do the following
</p>

<div class="org-src-container">
<pre class="src src-python" id="org0e0290e"><span class="org-variable-name">train_set</span>, <span class="org-variable-name">test_set</span> <span class="org-operator">=</span> shuffle_and_split_data<span class="org-rainbow-delimiters-depth-1">(</span>housing, 0.2<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Lets see the sizes of the datasets
</p>

<div class="org-src-container">
<pre class="src src-python" id="org14baed9"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"The size of the training set is:"</span>, <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>train_set<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"The size of the test data is:"</span>, <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>test_set<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org780dcc7">
The size of the training set is: 16512
The size of the test data is: 4128
</pre>

<p>
This will shuffle but because of shuffling the program will see
all the data eventually which is not something good.
</p>

<p>
To avoid it we set a RNG seed to keep the shuffled indices constant.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgce2f23b">np.random.seed<span class="org-rainbow-delimiters-depth-1">(</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Here is another method in which we can keep the split constant even if
the dataset is refreshed.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga2861b1"><span class="org-keyword">from</span> zlib <span class="org-keyword">import</span> crc32

<span class="org-keyword">def</span> <span class="org-function-name">is_id_in_test_set</span><span class="org-rainbow-delimiters-depth-1">(</span>identifier, test_ratio<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">return</span> crc32<span class="org-rainbow-delimiters-depth-1">(</span>np.int64<span class="org-rainbow-delimiters-depth-2">(</span>identifier<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">&lt;</span> test_ratio <span class="org-operator">*</span> 2<span class="org-operator">**</span>32

<span class="org-keyword">def</span> <span class="org-function-name">split_data_with_id_hash</span><span class="org-rainbow-delimiters-depth-1">(</span>data, test_ratio, id_column<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">ids</span> <span class="org-operator">=</span> data<span class="org-rainbow-delimiters-depth-1">[</span>id_column<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-variable-name">in_test_set</span> <span class="org-operator">=</span> ids.<span class="org-builtin">apply</span><span class="org-rainbow-delimiters-depth-1">(</span>
        <span class="org-keyword">lambda</span> id_: is_id_in_test_set<span class="org-rainbow-delimiters-depth-2">(</span>id_, test_ratio<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> data.loc<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-operator">~</span>in_test_set<span class="org-rainbow-delimiters-depth-1">]</span>, data.loc<span class="org-rainbow-delimiters-depth-1">[</span>in_test_set<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<p>
Unfortunately, the housing dataset does not have an identifier column.
The simplest solution is to use the row index as the ID:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1ed6780"><span class="org-variable-name">housing_with_id</span> <span class="org-operator">=</span> housing.reset_index<span class="org-rainbow-delimiters-depth-1">()</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">adds an `index` column</span>
<span class="org-variable-name">train_set</span>, <span class="org-variable-name">test_set</span> <span class="org-operator">=</span> split_data_with_id_hash<span class="org-rainbow-delimiters-depth-1">(</span>housing_with_id, 0.2, <span class="org-string">"index"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
If you use the row index as a unique identifier, you need to make
sure that new data gets appended to the end of the dataset and that no row ever gets deleted.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org98b126e"><span class="org-variable-name">housing_with_id</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"id"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"longitude"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">*</span> 1000 <span class="org-operator">+</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"latitude"</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">train_set</span>, <span class="org-variable-name">test_set</span> <span class="org-operator">=</span> split_data_with_id_hash<span class="org-rainbow-delimiters-depth-1">(</span>housing_with_id, 0.2, <span class="org-string">"id"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Scikit-Learn provides a few functions to split datasets into multiple subsets in various ways.
An easy function is <span class="Code">train_test_split()</span>
</p>

<div class="org-src-container">
<pre class="src src-python" id="org222a1f8"><span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> train_test_split

<span class="org-variable-name">train_set</span>, <span class="org-variable-name">test_set</span> <span class="org-operator">=</span> train_test_split<span class="org-rainbow-delimiters-depth-1">(</span>housing, test_size<span class="org-operator">=</span>0.2, random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
To find the probability that a random sample of 1,000 people contains less than 48.5% female or
more than 53.5% female when the population's female ratio is 51.1%, we use the binomial distribution.
</p>

<p>
The cdf() method of the binomial distribution gives us the probability that the
number of females will be equal or less than the given value.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb065518"><span class="org-keyword">from</span> scipy.stats <span class="org-keyword">import</span> binom

<span class="org-variable-name">sample_size</span> <span class="org-operator">=</span> 1000
<span class="org-variable-name">ratio_female</span> <span class="org-operator">=</span> 0.511
<span class="org-variable-name">proba_too_small</span> <span class="org-operator">=</span> binom<span class="org-rainbow-delimiters-depth-1">(</span>sample_size, ratio_female<span class="org-rainbow-delimiters-depth-1">)</span>.cdf<span class="org-rainbow-delimiters-depth-1">(</span>485 <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">proba_too_large</span> <span class="org-operator">=</span> 1 <span class="org-operator">-</span> binom<span class="org-rainbow-delimiters-depth-1">(</span>sample_size, ratio_female<span class="org-rainbow-delimiters-depth-1">)</span>.cdf<span class="org-rainbow-delimiters-depth-1">(</span>535<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>proba_too_small <span class="org-operator">+</span> proba_too_large<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgb06ed77">
0.10736798530930072
</pre>

<p>
However, for the ones who prefer numerical results over explicit solutions,
there is also the below method to achieve a similar result.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org87cdc47">np.random.seed<span class="org-rainbow-delimiters-depth-1">(</span>42<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">samples</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span>np.random.rand<span class="org-rainbow-delimiters-depth-2">(</span>100_000, sample_size<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">&lt;</span> ratio_female<span class="org-rainbow-delimiters-depth-1">)</span>.<span class="org-builtin">sum</span><span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>samples <span class="org-operator">&lt;</span> 485<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">|</span> <span class="org-rainbow-delimiters-depth-2">(</span>samples <span class="org-operator">&gt;</span> 535<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>.mean<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org63cb405">
0.1071
</pre>


<div class="org-src-container">
<pre class="src src-python" id="orge17bc5b"><span class="org-variable-name">housing</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> pd.cut<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-2">]</span>,
                               bins<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">[</span>0., 1.5, 3.0, 4.5, 6., np.inf<span class="org-rainbow-delimiters-depth-2">]</span>,
                               labels<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">[</span>1, 2, 3, 4, 5<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orge8cd87b">plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Income category"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Number of districts"</span><span class="org-rainbow-delimiters-depth-1">)</span>
housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-1">]</span>.value_counts<span class="org-rainbow-delimiters-depth-1">()</span>.sort_index<span class="org-rainbow-delimiters-depth-1">()</span>.plot.bar<span class="org-rainbow-delimiters-depth-1">(</span>rot<span class="org-operator">=</span>0, grid<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"housing-income-cat-bar-plot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org2e3b2d7" class="figure">
<p><img src="images/End-to-End-ML-Project/housing-income-cat-bar-plot.png" alt="housing-income-cat-bar-plot.png" />
</p>
</div>


<p>
Now you are ready to do stratified sampling based on the income category.
For this you can use Scikit-Learnâ€™s StratifiedShuffleSplit class:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1a392af"><span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> StratifiedShuffleSplit

<span class="org-variable-name">splitter</span> <span class="org-operator">=</span> StratifiedShuffleSplit<span class="org-rainbow-delimiters-depth-1">(</span>n_splits<span class="org-operator">=</span>10, test_size<span class="org-operator">=</span>0.2, random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">strat_splits</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[]</span>
<span class="org-keyword">for</span> train_index, test_index <span class="org-keyword">in</span> splitter.split<span class="org-rainbow-delimiters-depth-1">(</span>housing, housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">strat_train_set_n</span> <span class="org-operator">=</span> housing.iloc<span class="org-rainbow-delimiters-depth-1">[</span>train_index<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-variable-name">strat_test_set_n</span> <span class="org-operator">=</span> housing.iloc<span class="org-rainbow-delimiters-depth-1">[</span>test_index<span class="org-rainbow-delimiters-depth-1">]</span>
    strat_splits.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>strat_train_set_n, strat_test_set_n<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org273dfa1"><span class="org-variable-name">strat_train_set</span>, <span class="org-variable-name">strat_test_set</span> <span class="org-operator">=</span> strat_splits<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org054603e"><span class="org-variable-name">strat_train_set</span>, <span class="org-variable-name">strat_test_set</span> <span class="org-operator">=</span> train_test_split<span class="org-rainbow-delimiters-depth-1">(</span>
    housing,
    test_size<span class="org-operator">=</span>0.2,
    stratify<span class="org-operator">=</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-2">]</span>,
    random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org1d12636">strat_test_set<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-1">]</span>.value_counts<span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-operator">/</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>strat_test_set<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org602701a">
income_cat
3    0.350533
2    0.318798
4    0.176357
5    0.114341
1    0.039971
Name: count, dtype: float64
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge35d1d0"><span class="org-keyword">def</span> <span class="org-function-name">income_cat_proportions</span><span class="org-rainbow-delimiters-depth-1">(</span>data<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">return</span> data<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"income_cat"</span><span class="org-rainbow-delimiters-depth-1">]</span>.value_counts<span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-operator">/</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>data<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">train_set</span>, <span class="org-variable-name">test_set</span> <span class="org-operator">=</span> train_test_split<span class="org-rainbow-delimiters-depth-1">(</span>housing, test_size<span class="org-operator">=</span>0.2, random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">compare_props</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-string">"Overall %"</span>: income_cat_proportions<span class="org-rainbow-delimiters-depth-3">(</span>housing<span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-string">"Stratified %"</span>: income_cat_proportions<span class="org-rainbow-delimiters-depth-3">(</span>strat_test_set<span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-string">"Random %"</span>: income_cat_proportions<span class="org-rainbow-delimiters-depth-3">(</span>test_set<span class="org-rainbow-delimiters-depth-3">)</span>,
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>.sort_index<span class="org-rainbow-delimiters-depth-1">()</span>
compare_props.index.<span class="org-variable-name">name</span> <span class="org-operator">=</span> <span class="org-string">"Income Category"</span>
<span class="org-variable-name">compare_props</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"Strat. Error %"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span>compare_props<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Stratified %"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span>
                                   compare_props<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Overall %"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">compare_props</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"Rand. Error %"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span>compare_props<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Random %"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span>
                                  compare_props<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Overall %"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>compare_props <span class="org-operator">*</span> 100<span class="org-rainbow-delimiters-depth-1">)</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span>2<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgbc4efce">
                 Overall %  Stratified %  Random %  Strat. Error %  Rand. Error %
Income Category                                                                  
1                     3.98          4.00      4.24            0.36           6.45
2                    31.88         31.88     30.74           -0.02          -3.59
3                    35.06         35.05     34.52           -0.01          -1.53
4                    17.63         17.64     18.41            0.03           4.42
5                    11.44         11.43     12.09           -0.08           5.63
</pre>

<p>
Time to drop <span class="Code">income_cat()</span> attribute to go back to the
original state.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgc2dff81"><span class="org-keyword">for</span> set_ <span class="org-keyword">in</span> <span class="org-rainbow-delimiters-depth-1">(</span>strat_train_set, strat_test_set<span class="org-rainbow-delimiters-depth-1">)</span>:
    set_.drop<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"income_cat"</span>, axis<span class="org-operator">=</span>1, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6198fb9" class="outline-2">
<h2 id="org6198fb9">Discover and Visualize the Data to Gain Insights</h2>
<div class="outline-text-2" id="text-org6198fb9">
<p>
Before we start playing with the data it is a good habit to
create a copy so as to not tamper with the training set.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org88efd58"><span class="org-variable-name">housing</span> <span class="org-operator">=</span> strat_train_set.copy<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>
</div>

<div id="outline-container-orgc6578a0" class="outline-3">
<h3 id="orgc6578a0">Visualising Geographical Data</h3>
<div class="outline-text-3" id="text-orgc6578a0">
<p>
As data is a bunch of points in 2D space, it is benefical to
plot it in a scatter plot.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org7e7bbae">housing.plot<span class="org-rainbow-delimiters-depth-1">(</span>kind <span class="org-operator">=</span> <span class="org-string">"scatter"</span>,
             x <span class="org-operator">=</span> <span class="org-string">"longitude"</span>,
             y <span class="org-operator">=</span> <span class="org-string">"latitude"</span>,
             title <span class="org-operator">=</span> <span class="org-string">"Housing Market in California"</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"initial-visualisation-plot"</span>, close <span class="org-operator">=</span> <span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org64a358e" class="figure">
<p><img src="images/End-to-End-ML-Project/initial-visualisation-plot.png" alt="initial-visualisation-plot.png" />
</p>
</div>


<p>
This might remind you a state in a country but it is currently not
possible to see a pattern.
</p>

<p>
Let's set the <span class="Code">alpha</span> to 0.2 to see if it helps better.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgef873b3">housing.plot<span class="org-rainbow-delimiters-depth-1">(</span>kind <span class="org-operator">=</span> <span class="org-string">"scatter"</span>,
             x <span class="org-operator">=</span> <span class="org-string">"longitude"</span>,
             y <span class="org-operator">=</span> <span class="org-string">"latitude"</span>,
             title <span class="org-operator">=</span> r<span class="org-string">"Housing Market in California ($\alpha = 0.2$)"</span>,
             alpha <span class="org-operator">=</span> 0.2<span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"initial-visualisation-plot-with-alpha"</span>, close <span class="org-operator">=</span> <span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org5826fcc" class="figure">
<p><img src="images/End-to-End-ML-Project/initial-visualisation-plot-with-alpha.png" alt="initial-visualisation-plot-with-alpha.png" />
</p>
</div>

<p>
Let's make it a bit more interesting and create a plot where the higher cluster areas
would be coloured red and sparser places will be coloured colder as the value of
the land is less.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgd33811e">housing.plot<span class="org-rainbow-delimiters-depth-1">(</span>kind<span class="org-operator">=</span><span class="org-string">"scatter"</span>, x<span class="org-operator">=</span><span class="org-string">"longitude"</span>, y<span class="org-operator">=</span><span class="org-string">"latitude"</span>,
             s<span class="org-operator">=</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"population"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> 100, label<span class="org-operator">=</span><span class="org-string">"population"</span>,
             c<span class="org-operator">=</span><span class="org-string">"median_house_value"</span>, cmap<span class="org-operator">=</span><span class="org-string">"jet"</span>, colorbar<span class="org-operator">=</span><span class="org-constant">True</span>,
             legend<span class="org-operator">=</span><span class="org-constant">True</span>, sharex<span class="org-operator">=</span><span class="org-constant">False</span>, figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>10, 7<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"housing-prices-scatterplot"</span>, close <span class="org-operator">=</span> <span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="orge29c94d" class="figure">
<p><img src="images/End-to-End-ML-Project/housing-prices-scatterplot.png" alt="housing-prices-scatterplot.png" />
</p>
</div>

<p>
Now we can see the housing prices are very much related to the location
in this case closer to the ocean. To add a final addition let's superimpose
the state map over it.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgdedf603"><span class="org-variable-name">filename</span> <span class="org-operator">=</span> <span class="org-string">"california.png"</span>

<span class="org-keyword">if</span> <span class="org-keyword">not</span> <span class="org-rainbow-delimiters-depth-1">(</span>IMAGES_PATH <span class="org-operator">/</span> filename<span class="org-rainbow-delimiters-depth-1">)</span>.is_file<span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-variable-name">homl3_root</span> <span class="org-operator">=</span> <span class="org-string">"https://github.com/ageron/handson-ml3/raw/main/"</span>
    <span class="org-variable-name">url</span> <span class="org-operator">=</span> homl3_root <span class="org-operator">+</span> <span class="org-string">"images/end_to_end_project/"</span> <span class="org-operator">+</span> filename
    <span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Downloading"</span>, filename<span class="org-rainbow-delimiters-depth-1">)</span>
    urllib.request.urlretrieve<span class="org-rainbow-delimiters-depth-1">(</span>url, IMAGES_PATH <span class="org-operator">/</span> filename<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">housing_renamed</span> <span class="org-operator">=</span> housing.rename<span class="org-rainbow-delimiters-depth-1">(</span>columns<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-string">"latitude"</span>: <span class="org-string">"Latitude"</span>, <span class="org-string">"longitude"</span>: <span class="org-string">"Longitude"</span>,
    <span class="org-string">"population"</span>: <span class="org-string">"Population"</span>,
    <span class="org-string">"median_house_value"</span>: <span class="org-string">"Median house value (&#7452;s&#7429;)"</span><span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>

plot_settings<span class="org-rainbow-delimiters-depth-1">(</span>style <span class="org-operator">=</span> <span class="org-string">"slide"</span><span class="org-rainbow-delimiters-depth-1">)</span>
housing_renamed.plot<span class="org-rainbow-delimiters-depth-1">(</span>
             kind<span class="org-operator">=</span><span class="org-string">"scatter"</span>, x<span class="org-operator">=</span><span class="org-string">"Longitude"</span>, y<span class="org-operator">=</span><span class="org-string">"Latitude"</span>,
             s<span class="org-operator">=</span>housing_renamed<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Population"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> 100, label<span class="org-operator">=</span><span class="org-string">"Population"</span>,
             c<span class="org-operator">=</span><span class="org-string">"Median house value (&#7452;s&#7429;)"</span>, cmap<span class="org-operator">=</span><span class="org-string">"jet"</span>, colorbar<span class="org-operator">=</span><span class="org-constant">True</span>,
             legend<span class="org-operator">=</span><span class="org-constant">True</span>, sharex<span class="org-operator">=</span><span class="org-constant">False</span>, figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>10, 7<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">california_img</span> <span class="org-operator">=</span> plt.imread<span class="org-rainbow-delimiters-depth-1">(</span>IMAGES_PATH <span class="org-operator">/</span> filename<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">axis</span> <span class="org-operator">=</span> <span class="org-operator">-</span>124.55, <span class="org-operator">-</span>113.95, 32.45, 42.05
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-rainbow-delimiters-depth-1">)</span>
plt.imshow<span class="org-rainbow-delimiters-depth-1">(</span>california_img, extent<span class="org-operator">=</span>axis<span class="org-rainbow-delimiters-depth-1">)</span>

store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"california-housing-prices-plot"</span>,
          style <span class="org-operator">=</span> <span class="org-string">"slide"</span>,
          close <span class="org-operator">=</span> <span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="orga07b444" class="figure">
<p><img src="images/End-to-End-ML-Project/california-housing-prices-plot.png" alt="california-housing-prices-plot.png" />
</p>
</div>


<div id="org0fe2227" class="figure">
<p><img src="images/End-to-End-ML-Project/california-housing-prices-plot.png" alt="california-housing-prices-plot.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgf40f08c" class="outline-3">
<h3 id="orgf40f08c">Looking for Correlations</h3>
<div class="outline-text-3" id="text-orgf40f08c">
<p>
Time to see if there is any correlation between the value of the houses
and other parameters using pearsons correlation
</p>

<div class="org-src-container">
<pre class="src src-python" id="org194812f"><span class="org-variable-name">corr_matrix</span> <span class="org-operator">=</span> housing.corr<span class="org-rainbow-delimiters-depth-1">(</span>numeric_only<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
corr_matrix<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"median_house_value"</span><span class="org-rainbow-delimiters-depth-1">]</span>.sort_values<span class="org-rainbow-delimiters-depth-1">(</span>ascending<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org586ffc9">
median_house_value    1.000000
median_income         0.688380
total_rooms           0.137455
housing_median_age    0.102175
households            0.071426
total_bedrooms        0.054635
population           -0.020153
longitude            -0.050859
latitude             -0.139584
Name: median_house_value, dtype: float64
</pre>

<p>
Another way to check for correlation between attributes is to
use the pandas scatter<sub>matrix</sub>() function, 
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgc1fb6d4"><span class="org-keyword">from</span> pandas.plotting <span class="org-keyword">import</span> scatter_matrix

<span class="org-variable-name">attributes</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"median_house_value"</span>, <span class="org-string">"median_income"</span>, <span class="org-string">"total_rooms"</span>,
              <span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-1">]</span>

scatter_matrix<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span>attributes<span class="org-rainbow-delimiters-depth-2">]</span>, figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>12, 8<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"scatter-matrix-plot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">extra code</span>
</pre>
</div>


<div id="orgfeac64a" class="figure">
<p><img src="images/End-to-End-ML-Project/scatter-matrix-plot.png" alt="scatter-matrix-plot.png" />
</p>
</div>


<p>
The most promising attribute to predict the median house value
is the median income, 
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga158776">housing.plot<span class="org-rainbow-delimiters-depth-1">(</span>kind<span class="org-operator">=</span><span class="org-string">"scatter"</span>,
             x<span class="org-operator">=</span><span class="org-string">"median_income"</span>,
             y<span class="org-operator">=</span><span class="org-string">"median_house_value"</span>,
             alpha<span class="org-operator">=</span>0.1, grid<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"income-vs-house-value-scatterplot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span> 
</pre>
</div>


<div id="org5f6f754" class="figure">
<p><img src="images/End-to-End-ML-Project/income-vs-house-value-scatterplot.png" alt="income-vs-house-value-scatterplot.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org0b1a16e" class="outline-3">
<h3 id="org0b1a16e">Experimenting with Attribute Combinations</h3>
<div class="outline-text-3" id="text-org0b1a16e">
<div class="org-src-container">
<pre class="src src-python" id="org6982855"><span class="org-variable-name">housing</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"rooms_per_house"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"total_rooms"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">/</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"households"</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">housing</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"bedrooms_ratio"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"total_bedrooms"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">/</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"total_rooms"</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">housing</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"people_per_house"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"population"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">/</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"households"</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orga7177ab"><span class="org-variable-name">corr_matrix</span> <span class="org-operator">=</span> housing.corr<span class="org-rainbow-delimiters-depth-1">(</span>numeric_only<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
corr_matrix<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"median_house_value"</span><span class="org-rainbow-delimiters-depth-1">]</span>.sort_values<span class="org-rainbow-delimiters-depth-1">(</span>ascending<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc4349e5">
median_house_value    1.000000
median_income         0.688380
rooms_per_house       0.143663
total_rooms           0.137455
housing_median_age    0.102175
households            0.071426
total_bedrooms        0.054635
population           -0.020153
people_per_house     -0.038224
longitude            -0.050859
latitude             -0.139584
bedrooms_ratio       -0.256397
Name: median_house_value, dtype: float64
</pre>
</div>
</div>
</div>

<div id="outline-container-orgee8751a" class="outline-2">
<h2 id="orgee8751a">Prepare the Data for Machine Learning Algorithms</h2>
<div class="outline-text-2" id="text-orgee8751a">
<p>
Itâ€™s time to prepare the data for your Machine Learning algorithms.
Instead of doing this manually, you should write functions for this
purpose, 
</p>

<p>
First revert to a clean training set and separate predictors and labels.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org174c31c"><span class="org-variable-name">housing</span> <span class="org-operator">=</span> strat_train_set.drop<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"median_house_value"</span>, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">housing_labels</span> <span class="org-operator">=</span> strat_train_set<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"median_house_value"</span><span class="org-rainbow-delimiters-depth-1">]</span>.copy<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>
</div>

<div id="outline-container-org07d80f2" class="outline-3">
<h3 id="org07d80f2">Data Cleaning</h3>
<div class="outline-text-3" id="text-org07d80f2">
<p>
Not all data comes perfect for ML as some of them may contain NaN or 0 or
some other value which you don't want ML algorithm to process.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org01d8010"><span class="org-variable-name">null_rows_idx</span> <span class="org-operator">=</span> housing.isnull<span class="org-rainbow-delimiters-depth-1">()</span>.<span class="org-builtin">any</span><span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
housing.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org28c65a4">
       longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income ocean_proximity
14452    -120.67     40.50                15.0       5343.0             NaN      2503.0       902.0         3.5962          INLAND
18217    -117.96     34.03                35.0       2093.0             NaN      1755.0       403.0         3.4115       &lt;1H OCEAN
11889    -118.05     34.04                33.0       1348.0             NaN      1098.0       257.0         4.2917       &lt;1H OCEAN
20325    -118.88     34.17                15.0       4260.0             NaN      1701.0       669.0         5.1033       &lt;1H OCEAN
14360    -117.87     33.62                 8.0       1266.0             NaN       375.0       183.0         9.8020       &lt;1H OCEAN
</pre>

<p>
Let's look at three (<span class="Hlight">3</span>) options:
</p>

<p>
1 - Get rid of the corresponding districts
</p>

<div class="org-src-container">
<pre class="src src-python" id="org79cacbf"><span class="org-variable-name">housing_option1</span> <span class="org-operator">=</span> housing.copy<span class="org-rainbow-delimiters-depth-1">()</span>
housing_option1.dropna<span class="org-rainbow-delimiters-depth-1">(</span>subset<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"total_bedrooms"</span><span class="org-rainbow-delimiters-depth-2">]</span>, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
housing_option1.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="orgcc19957">
Empty DataFrame
Columns: [longitude, latitude, housing_median_age, total_rooms, total_bedrooms, population, households, median_income, ocean_proximity]
Index: []
</pre>

<p>
2 - Get rid of the whole attribute
</p>

<div class="org-src-container">
<pre class="src src-python" id="org7481c13"><span class="org-variable-name">housing_option2</span> <span class="org-operator">=</span> housing.copy<span class="org-rainbow-delimiters-depth-1">()</span>
housing_option2.drop<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"total_bedrooms"</span>, axis<span class="org-operator">=</span>1, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
housing_option2.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org76afb61">
       longitude  latitude  housing_median_age  total_rooms  population  households  median_income ocean_proximity
14452    -120.67     40.50                15.0       5343.0      2503.0       902.0         3.5962          INLAND
18217    -117.96     34.03                35.0       2093.0      1755.0       403.0         3.4115       &lt;1H OCEAN
11889    -118.05     34.04                33.0       1348.0      1098.0       257.0         4.2917       &lt;1H OCEAN
20325    -118.88     34.17                15.0       4260.0      1701.0       669.0         5.1033       &lt;1H OCEAN
14360    -117.87     33.62                 8.0       1266.0       375.0       183.0         9.8020       &lt;1H OCEAN
</pre>

<p>
3 - Set the values to some value (zero, the mean, the median, etc.).
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb13b9d2"><span class="org-variable-name">housing_option3</span> <span class="org-operator">=</span> housing.copy<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">median</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"total_bedrooms"</span><span class="org-rainbow-delimiters-depth-1">]</span>.median<span class="org-rainbow-delimiters-depth-1">()</span>
housing_option3<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"total_bedrooms"</span><span class="org-rainbow-delimiters-depth-1">]</span>.fillna<span class="org-rainbow-delimiters-depth-1">(</span>median, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

housing_option3.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="orga04d3dc">
       longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income ocean_proximity
14452    -120.67     40.50                15.0       5343.0           434.0      2503.0       902.0         3.5962          INLAND
18217    -117.96     34.03                35.0       2093.0           434.0      1755.0       403.0         3.4115       &lt;1H OCEAN
11889    -118.05     34.04                33.0       1348.0           434.0      1098.0       257.0         4.2917       &lt;1H OCEAN
20325    -118.88     34.17                15.0       4260.0           434.0      1701.0       669.0         5.1033       &lt;1H OCEAN
14360    -117.87     33.62                 8.0       1266.0           434.0       375.0       183.0         9.8020       &lt;1H OCEAN
</pre>

<p>
Scikit-Learn provides a handy class to take care of missing values: SimpleImputer.
</p>

<p>
Separating out the numerical attributes to use the "median" strategy 
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgc4471ec"><span class="org-keyword">from</span> sklearn.impute <span class="org-keyword">import</span> SimpleImputer

<span class="org-variable-name">imputer</span> <span class="org-operator">=</span> SimpleImputer<span class="org-rainbow-delimiters-depth-1">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
create a copy of the data without the text attribute ocean<sub>proximity</sub>:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org563b20d"><span class="org-variable-name">housing_num</span> <span class="org-operator">=</span> housing.select_dtypes<span class="org-rainbow-delimiters-depth-1">(</span>include<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">[</span>np.number<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<p>
can fit the imputer instance to the training data using the fit() method:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3725aa0">imputer.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing_num<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
we cannot be sure that there wonâ€™t be any missing values in new
data after the system goes live, so it is safer to apply the
imputer to all the numerical attributes:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3b14f40"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>imputer.statistics_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org8242dc7">
[-118.51     34.26     29.     2125.      434.     1167.      408.
    3.5385]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org6bcb163"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_num.median<span class="org-rainbow-delimiters-depth-2">()</span>.values<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org3945088">
[-118.51     34.26     29.     2125.      434.     1167.      408.
    3.5385]
</pre>

<p>
use this â€œtrainedâ€ imputer to transform the training set by
replacing missing values with the learned medians:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org20aaca9"><span class="org-variable-name">X</span> <span class="org-operator">=</span> imputer.transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_num<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">to see the name of the columns</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>imputer.feature_names_in_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org191da95">
['longitude' 'latitude' 'housing_median_age' 'total_rooms'
 'total_bedrooms' 'population' 'households' 'median_income']
</pre>

<p>
To convert this to pd dataframe:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org7017181"><span class="org-variable-name">housing_tr</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>X, columns<span class="org-operator">=</span>housing_num.columns,
                          index<span class="org-operator">=</span>housing_num.index<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgfb1ec3a">housing_tr.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org79a588a">
       longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income
14452    -120.67     40.50                15.0       5343.0           434.0      2503.0       902.0         3.5962
18217    -117.96     34.03                35.0       2093.0           434.0      1755.0       403.0         3.4115
11889    -118.05     34.04                33.0       1348.0           434.0      1098.0       257.0         4.2917
20325    -118.88     34.17                15.0       4260.0           434.0      1701.0       669.0         5.1033
14360    -117.87     33.62                 8.0       1266.0           434.0       375.0       183.0         9.8020
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org26df26e">imputer.strategy
</pre>
</div>

<pre class="example" id="org56e32b8">
median
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgb417819"><span class="org-variable-name">housing_tr</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>X, columns<span class="org-operator">=</span>housing_num.columns,
                          index<span class="org-operator">=</span>housing_num.index<span class="org-rainbow-delimiters-depth-1">)</span>

housing_tr.loc<span class="org-rainbow-delimiters-depth-1">[</span>null_rows_idx<span class="org-rainbow-delimiters-depth-1">]</span>.head<span class="org-rainbow-delimiters-depth-1">()</span> 
</pre>
</div>

<pre class="example" id="org2787e2a">
       longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income
14452    -120.67     40.50                15.0       5343.0           434.0      2503.0       902.0         3.5962
18217    -117.96     34.03                35.0       2093.0           434.0      1755.0       403.0         3.4115
11889    -118.05     34.04                33.0       1348.0           434.0      1098.0       257.0         4.2917
20325    -118.88     34.17                15.0       4260.0           434.0      1701.0       669.0         5.1033
14360    -117.87     33.62                 8.0       1266.0           434.0       375.0       183.0         9.8020
</pre>

<p>
Time to drop some outliers.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9ff270c"><span class="org-keyword">from</span> sklearn.ensemble <span class="org-keyword">import</span> IsolationForest

<span class="org-variable-name">isolation_forest</span> <span class="org-operator">=</span> IsolationForest<span class="org-rainbow-delimiters-depth-1">(</span>random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">outlier_pred</span> <span class="org-operator">=</span> isolation_forest.fit_predict<span class="org-rainbow-delimiters-depth-1">(</span>X<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>outlier_pred<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org7f06e35">
[-1  1  1 ...  1  1  1]
</pre>
</div>
</div>

<div id="outline-container-org628048a" class="outline-3">
<h3 id="org628048a">Handling Text and Categorical Attributes</h3>
<div class="outline-text-3" id="text-org628048a">
<p>
Time to process text instead of numbers.
</p>

<p>
In this dataset, there is just one: the ocean<sub>proximity</sub> attribute.
Letâ€™s look at its value for the first 10 instances:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org00faba3"><span class="org-variable-name">housing_cat</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"ocean_proximity"</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>
housing_cat.head<span class="org-rainbow-delimiters-depth-1">(</span>8<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org5c45d7c">
      ocean_proximity
13096        NEAR BAY
14973       &lt;1H OCEAN
3785           INLAND
14689          INLAND
20507      NEAR OCEAN
1286           INLAND
18078       &lt;1H OCEAN
4396         NEAR BAY
</pre>

<p>
As ML likes numbers instead of text, convert these values to numbers
using <span class="Code">OrdinalEncoder</span> class from Scikit-learn
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga57808e"><span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> OrdinalEncoder

<span class="org-variable-name">ordinal_encoder</span> <span class="org-operator">=</span> OrdinalEncoder<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">housing_cat_encoded</span> <span class="org-operator">=</span> ordinal_encoder.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_cat<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Let's see the results
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga8af0c2"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_cat_encoded<span class="org-rainbow-delimiters-depth-2">[</span>:8<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgf1727ac">
[[3.]
 [0.]
 [1.]
 [1.]
 [4.]
 [1.]
 [0.]
 [3.]]
</pre>

<p>
And if we were to see the categories:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org5f72258"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>ordinal_encoder.categories_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgd8ab8f1">
[array(['&lt;1H OCEAN', 'INLAND', 'ISLAND', 'NEAR BAY', 'NEAR OCEAN'],
      dtype=object)]
</pre>

<p>
To stop from ML algorithm from treating the numbers too literally
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgaa08f4e"><span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> OneHotEncoder

<span class="org-variable-name">cat_encoder</span> <span class="org-operator">=</span> OneHotEncoder<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">housing_cat_1hot</span> <span class="org-operator">=</span> cat_encoder.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_cat<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgdcb2ddd"><span class="org-builtin">type</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_cat_1hot<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org7fa780c">
&lt;class 'scipy.sparse._csr.csr_matrix'&gt;
</pre>

<p>
the output is a SciPy sparse matrix, instead of a NumPy array.
</p>

<p>
convert it to a dense array if needed by calling the toarray() method:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgeb3548a"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_cat_1hot.toarray<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgb00231e">
[[0. 0. 0. 1. 0.]
 [1. 0. 0. 0. 0.]
 [0. 1. 0. 0. 0.]
 ...
 [0. 0. 0. 0. 1.]
 [1. 0. 0. 0. 0.]
 [0. 0. 0. 0. 1.]]
</pre>

<p>
It is also possible to list categories using categoreis_ instance
</p>

<div class="org-src-container">
<pre class="src src-python" id="org210b875"><span class="org-variable-name">cat_encoder</span> <span class="org-operator">=</span> OneHotEncoder<span class="org-rainbow-delimiters-depth-1">(</span>sparse_output<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">housing_cat_1hot</span> <span class="org-operator">=</span> cat_encoder.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_cat<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_cat_1hot<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orga09b5d8">
[[0. 0. 0. 1. 0.]
 [1. 0. 0. 0. 0.]
 [0. 1. 0. 0. 0.]
 ...
 [0. 0. 0. 0. 1.]
 [1. 0. 0. 0. 0.]
 [0. 0. 0. 0. 1.]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org547b188"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.categories_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org58d2faf">
[array(['&lt;1H OCEAN', 'INLAND', 'ISLAND', 'NEAR BAY', 'NEAR OCEAN'],
      dtype=object)]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgbc477a0"><span class="org-variable-name">df_test</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">"ocean_proximity"</span>: <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"INLAND"</span>, <span class="org-string">"NEAR BAY"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>
pd.get_dummies<span class="org-rainbow-delimiters-depth-1">(</span>df_test<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org8c49115">
   ocean_proximity_INLAND  ocean_proximity_NEAR BAY
0                    True                     False
1                   False                      True
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge526e87"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.transform<span class="org-rainbow-delimiters-depth-2">(</span>df_test<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgb895bff">
[[0. 1. 0. 0. 0.]
 [0. 0. 0. 1. 0.]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org409fb04"><span class="org-variable-name">df_test_unknown</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">"ocean_proximity"</span>: <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"&lt;2H OCEAN"</span>, <span class="org-string">"ISLAND"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>
pd.get_dummies<span class="org-rainbow-delimiters-depth-1">(</span>df_test_unknown<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org41c255f">
   ocean_proximity_&lt;2H OCEAN  ocean_proximity_ISLAND
0                       True                   False
1                      False                    True
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org0fa5f14">cat_encoder.<span class="org-variable-name">handle_unknown</span> <span class="org-operator">=</span> <span class="org-string">"ignore"</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.transform<span class="org-rainbow-delimiters-depth-2">(</span>df_test_unknown<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org63872da">
[[0. 0. 0. 0. 0.]
 [0. 0. 1. 0. 0.]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org1bde535"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.feature_names_in_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org942b3fe">
['ocean_proximity']
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org77f477e"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.get_feature_names_out<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org0c79aff">
['ocean_proximity_&lt;1H OCEAN' 'ocean_proximity_INLAND'
 'ocean_proximity_ISLAND' 'ocean_proximity_NEAR BAY'
 'ocean_proximity_NEAR OCEAN']
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org3a0571f"><span class="org-variable-name">df_output</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>cat_encoder.transform<span class="org-rainbow-delimiters-depth-2">(</span>df_test_unknown<span class="org-rainbow-delimiters-depth-2">)</span>,
                         columns<span class="org-operator">=</span>cat_encoder.get_feature_names_out<span class="org-rainbow-delimiters-depth-2">()</span>,
                         index<span class="org-operator">=</span>df_test_unknown.index<span class="org-rainbow-delimiters-depth-1">)</span>

df_output
</pre>
</div>

<pre class="example" id="org4d0dd7a">
   ocean_proximity_&lt;1H OCEAN  ocean_proximity_INLAND  ocean_proximity_ISLAND  ocean_proximity_NEAR BAY  ocean_proximity_NEAR OCEAN
0                        0.0                     0.0                     0.0                       0.0                         0.0
1                        0.0                     0.0                     1.0                       0.0                         0.0
</pre>
</div>
</div>

<div id="outline-container-org2ccd232" class="outline-3">
<h3 id="org2ccd232">Feature Scaling</h3>
<div class="outline-text-3" id="text-org2ccd232">
<div class="org-src-container">
<pre class="src src-python" id="orgdb8b3c5"><span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> MinMaxScaler

<span class="org-variable-name">min_max_scaler</span> <span class="org-operator">=</span> MinMaxScaler<span class="org-rainbow-delimiters-depth-1">(</span>feature_range<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-operator">-</span>1, 1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">housing_num_min_max_scaled</span> <span class="org-operator">=</span> min_max_scaler.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_num<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgb6b32f5"><span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> StandardScaler

<span class="org-variable-name">std_scaler</span> <span class="org-operator">=</span> StandardScaler<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">housing_num_std_scaled</span> <span class="org-operator">=</span> std_scaler.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_num<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orga782a2b"><span class="org-variable-name">fig</span>, <span class="org-variable-name">axs</span> <span class="org-operator">=</span> plt.subplots<span class="org-rainbow-delimiters-depth-1">(</span>1, 2, figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>8, 3<span class="org-rainbow-delimiters-depth-2">)</span>, sharey<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"population"</span><span class="org-rainbow-delimiters-depth-1">]</span>.hist<span class="org-rainbow-delimiters-depth-1">(</span>ax<span class="org-operator">=</span>axs<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>, bins<span class="org-operator">=</span>50<span class="org-rainbow-delimiters-depth-1">)</span>
housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"population"</span><span class="org-rainbow-delimiters-depth-1">]</span>.<span class="org-builtin">apply</span><span class="org-rainbow-delimiters-depth-1">(</span>np.log<span class="org-rainbow-delimiters-depth-1">)</span>.hist<span class="org-rainbow-delimiters-depth-1">(</span>ax<span class="org-operator">=</span>axs<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>, bins<span class="org-operator">=</span>50<span class="org-rainbow-delimiters-depth-1">)</span>
axs<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.set_xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Population"</span><span class="org-rainbow-delimiters-depth-1">)</span>
axs<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>.set_xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Log of population"</span><span class="org-rainbow-delimiters-depth-1">)</span>
axs<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.set_ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Number of districts"</span><span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"long-tail-plot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org6e7c8f6" class="figure">
<p><img src="images/End-to-End-ML-Project/long-tail-plot.png" alt="long-tail-plot.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgb84e78b"><span class="org-variable-name">percentiles</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span>np.percentile<span class="org-rainbow-delimiters-depth-2">(</span>housing<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-3">]</span>, p<span class="org-rainbow-delimiters-depth-2">)</span>
               <span class="org-keyword">for</span> p <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-2">(</span>1, 100<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">flattened_median_income</span> <span class="org-operator">=</span> pd.cut<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-2">]</span>,
                                 bins<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-operator">-</span>np.inf<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">+</span> percentiles <span class="org-operator">+</span> <span class="org-rainbow-delimiters-depth-2">[</span>np.inf<span class="org-rainbow-delimiters-depth-2">]</span>,
                                 labels<span class="org-operator">=</span><span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-2">(</span>1, 100 <span class="org-operator">+</span> 1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
flattened_median_income.hist<span class="org-rainbow-delimiters-depth-1">(</span>bins<span class="org-operator">=</span>50<span class="org-rainbow-delimiters-depth-1">)</span>
plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Median income percentile"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Number of districts"</span><span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"long-tail-dist"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org7ea781d" class="figure">
<p><img src="images/End-to-End-ML-Project/long-tail-dist.png" alt="long-tail-dist.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org083a735"><span class="org-keyword">from</span> sklearn.metrics.pairwise <span class="org-keyword">import</span> rbf_kernel

<span class="org-variable-name">age_simil_35</span> <span class="org-operator">=</span> rbf_kernel<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>35<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, gamma<span class="org-operator">=</span>0.1<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org543623d"><span class="org-variable-name">ages</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-2">]</span>.<span class="org-builtin">min</span><span class="org-rainbow-delimiters-depth-2">()</span>,
                   housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-2">]</span>.<span class="org-builtin">max</span><span class="org-rainbow-delimiters-depth-2">()</span>,
                   500<span class="org-rainbow-delimiters-depth-1">)</span>.reshape<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">-</span>1, 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">gamma1</span> <span class="org-operator">=</span> 0.1
<span class="org-variable-name">gamma2</span> <span class="org-operator">=</span> 0.03
<span class="org-variable-name">rbf1</span> <span class="org-operator">=</span> rbf_kernel<span class="org-rainbow-delimiters-depth-1">(</span>ages, <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>35<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, gamma<span class="org-operator">=</span>gamma1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">rbf2</span> <span class="org-operator">=</span> rbf_kernel<span class="org-rainbow-delimiters-depth-1">(</span>ages, <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>35<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, gamma<span class="org-operator">=</span>gamma2<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax1</span> <span class="org-operator">=</span> plt.subplots<span class="org-rainbow-delimiters-depth-1">()</span>

ax1.set_xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Housing median age"</span><span class="org-rainbow-delimiters-depth-1">)</span>
ax1.set_ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Number of districts"</span><span class="org-rainbow-delimiters-depth-1">)</span>
ax1.hist<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-2">]</span>, bins<span class="org-operator">=</span>50<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">ax2</span> <span class="org-operator">=</span> ax1.twinx<span class="org-rainbow-delimiters-depth-1">()</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">create a twin axis that shares the same x-axis</span>
<span class="org-variable-name">color</span> <span class="org-operator">=</span> <span class="org-string">"</span><span class="custom"><span class="custom-1">#984ea3</span></span><span class="org-string">"</span>
ax2.plot<span class="org-rainbow-delimiters-depth-1">(</span>ages, rbf1, color<span class="org-operator">=</span>color, label<span class="org-operator">=</span><span class="org-string">"gamma = 0.10"</span><span class="org-rainbow-delimiters-depth-1">)</span>
ax2.plot<span class="org-rainbow-delimiters-depth-1">(</span>ages, rbf2, color<span class="org-operator">=</span>color, label<span class="org-operator">=</span><span class="org-string">"gamma = 0.03"</span>, linestyle<span class="org-operator">=</span><span class="org-string">"--"</span><span class="org-rainbow-delimiters-depth-1">)</span>
ax2.tick_params<span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span><span class="org-string">'y'</span>, labelcolor<span class="org-operator">=</span>color<span class="org-rainbow-delimiters-depth-1">)</span>
ax2.set_ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Age similarity"</span>, color<span class="org-operator">=</span>color<span class="org-rainbow-delimiters-depth-1">)</span>

plt.legend<span class="org-rainbow-delimiters-depth-1">(</span>loc<span class="org-operator">=</span><span class="org-string">"upper left"</span><span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"age-similarity-plot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="orgf06287a" class="figure">
<p><img src="images/End-to-End-ML-Project/age-similarity-plot.png" alt="age-similarity-plot.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgff8f5ee"><span class="org-keyword">from</span> sklearn.linear_model <span class="org-keyword">import</span> LinearRegression

<span class="org-variable-name">target_scaler</span> <span class="org-operator">=</span> StandardScaler<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">scaled_labels</span> <span class="org-operator">=</span> target_scaler.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_labels.to_frame<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">model</span> <span class="org-operator">=</span> LinearRegression<span class="org-rainbow-delimiters-depth-1">()</span>
model.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, scaled_labels<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">some_new_data</span> <span class="org-operator">=</span> housing<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>.iloc<span class="org-rainbow-delimiters-depth-1">[</span>:5<span class="org-rainbow-delimiters-depth-1">]</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">pretend this is new data</span>

<span class="org-variable-name">scaled_predictions</span> <span class="org-operator">=</span> model.predict<span class="org-rainbow-delimiters-depth-1">(</span>some_new_data<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">predictions</span> <span class="org-operator">=</span> target_scaler.inverse_transform<span class="org-rainbow-delimiters-depth-1">(</span>scaled_predictions<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orge1d1781"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>predictions<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org01e0c79">
[[131997.15275877]
 [299359.35844434]
 [146023.37185694]
 [138840.33653057]
 [192016.61557639]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org73dbf3f"><span class="org-keyword">from</span> sklearn.compose <span class="org-keyword">import</span> TransformedTargetRegressor

<span class="org-variable-name">model</span> <span class="org-operator">=</span> TransformedTargetRegressor<span class="org-rainbow-delimiters-depth-1">(</span>LinearRegression<span class="org-rainbow-delimiters-depth-2">()</span>,
                                   transformer<span class="org-operator">=</span>StandardScaler<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
model.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>, housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">predictions</span> <span class="org-operator">=</span> model.predict<span class="org-rainbow-delimiters-depth-1">(</span>some_new_data<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org993b0df"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>predictions<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org8d3c1d5">
[131997.15275877 299359.35844434 146023.37185694 138840.33653057
 192016.61557639]
</pre>
</div>
</div>

<div id="outline-container-org4526581" class="outline-3">
<h3 id="org4526581">Custom Transformers</h3>
<div class="outline-text-3" id="text-org4526581">
<div class="org-src-container">
<pre class="src src-python" id="org2c9fbd2"><span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> FunctionTransformer

<span class="org-variable-name">log_transformer</span> <span class="org-operator">=</span> FunctionTransformer<span class="org-rainbow-delimiters-depth-1">(</span>np.log, inverse_func<span class="org-operator">=</span>np.exp<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">log_pop</span> <span class="org-operator">=</span> log_transformer.transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"population"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org70b09ab"><span class="org-variable-name">rbf_transformer</span> <span class="org-operator">=</span> FunctionTransformer<span class="org-rainbow-delimiters-depth-1">(</span>rbf_kernel,
                                      kw_args<span class="org-operator">=</span><span class="org-builtin">dict</span><span class="org-rainbow-delimiters-depth-2">(</span>Y<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-rainbow-delimiters-depth-4">[</span>35.<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span>, gamma<span class="org-operator">=</span>0.1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">age_simil_35</span> <span class="org-operator">=</span> rbf_transformer.transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"housing_median_age"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgf5e25d4"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>age_simil_35<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org528eeec">
[[2.81118530e-13]
 [8.20849986e-02]
 [6.70320046e-01]
 ...
 [9.55316054e-22]
 [6.70320046e-01]
 [3.03539138e-04]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge46ac14"><span class="org-variable-name">sf_coords</span> <span class="org-operator">=</span> 37.7749, <span class="org-operator">-</span>122.41
<span class="org-variable-name">sf_transformer</span> <span class="org-operator">=</span> FunctionTransformer<span class="org-rainbow-delimiters-depth-1">(</span>rbf_kernel,
                                     kw_args<span class="org-operator">=</span><span class="org-builtin">dict</span><span class="org-rainbow-delimiters-depth-2">(</span>Y<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-3">[</span>sf_coords<span class="org-rainbow-delimiters-depth-3">]</span>, gamma<span class="org-operator">=</span>0.1<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">sf_simil</span> <span class="org-operator">=</span> sf_transformer.transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"latitude"</span>, <span class="org-string">"longitude"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org168bd34"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>sf_simil<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org493ba58">
[[0.999927  ]
 [0.05258419]
 [0.94864161]
 ...
 [0.00388525]
 [0.05038518]
 [0.99868067]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org4fcb448"><span class="org-variable-name">ratio_transformer</span> <span class="org-operator">=</span> FunctionTransformer<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">lambda</span> X: X<span class="org-rainbow-delimiters-depth-2">[</span>:, <span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> X<span class="org-rainbow-delimiters-depth-2">[</span>:, <span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>ratio_transformer.transform<span class="org-rainbow-delimiters-depth-2">(</span>np.array<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">[</span><span class="org-rainbow-delimiters-depth-5">[</span>1., 2.<span class="org-rainbow-delimiters-depth-5">]</span>, <span class="org-rainbow-delimiters-depth-5">[</span>3., 4.<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org62672ee">
[[0.5 ]
 [0.75]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org527746b"><span class="org-keyword">from</span> sklearn.base <span class="org-keyword">import</span> BaseEstimator, TransformerMixin
<span class="org-keyword">from</span> sklearn.utils.validation <span class="org-keyword">import</span> check_array, check_is_fitted

<span class="org-keyword">class</span> <span class="org-type">StandardScalerClone</span><span class="org-rainbow-delimiters-depth-1">(</span>BaseEstimator, TransformerMixin<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, with_mean<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">no *args or **kwargs!</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">with_mean</span> <span class="org-operator">=</span> with_mean

    <span class="org-keyword">def</span> <span class="org-function-name">fit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, X, y<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">y is required even though we don't use it</span>
        <span class="org-variable-name">X</span> <span class="org-operator">=</span> check_array<span class="org-rainbow-delimiters-depth-1">(</span>X<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">checks that X is an array with finite float values</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">mean_</span> <span class="org-operator">=</span> X.mean<span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">scale_</span> <span class="org-operator">=</span> X.std<span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">n_features_in_</span> <span class="org-operator">=</span> X.shape<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">every estimator stores this in fit()</span>
        <span class="org-keyword">return</span> <span class="org-keyword">self</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">always return self!</span>

    <span class="org-keyword">def</span> <span class="org-function-name">transform</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, X<span class="org-rainbow-delimiters-depth-1">)</span>:
        check_is_fitted<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">looks for learned attributes (with trailing _)</span>
        <span class="org-variable-name">X</span> <span class="org-operator">=</span> check_array<span class="org-rainbow-delimiters-depth-1">(</span>X<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">assert</span> <span class="org-keyword">self</span>.n_features_in_ <span class="org-operator">==</span> X.shape<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.with_mean:
            <span class="org-variable-name">X</span> <span class="org-operator">=</span> X <span class="org-operator">-</span> <span class="org-keyword">self</span>.mean_
        <span class="org-keyword">return</span> X <span class="org-operator">/</span> <span class="org-keyword">self</span>.scale_
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgb7a0f17"><span class="org-keyword">from</span> sklearn.cluster <span class="org-keyword">import</span> KMeans

<span class="org-keyword">class</span> <span class="org-type">ClusterSimilarity</span><span class="org-rainbow-delimiters-depth-1">(</span>BaseEstimator, TransformerMixin<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, n_clusters<span class="org-operator">=</span>10, gamma<span class="org-operator">=</span>1.0, random_state<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">self</span>.<span class="org-variable-name">n_clusters</span> <span class="org-operator">=</span> n_clusters
        <span class="org-keyword">self</span>.<span class="org-variable-name">gamma</span> <span class="org-operator">=</span> gamma
        <span class="org-keyword">self</span>.<span class="org-variable-name">random_state</span> <span class="org-operator">=</span> random_state

    <span class="org-keyword">def</span> <span class="org-function-name">fit</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, X, y<span class="org-operator">=</span><span class="org-constant">None</span>, sample_weight<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">self</span>.<span class="org-variable-name">kmeans_</span> <span class="org-operator">=</span> KMeans<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>.n_clusters, n_init<span class="org-operator">=</span>10,
                              random_state<span class="org-operator">=</span><span class="org-keyword">self</span>.random_state<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">self</span>.kmeans_.fit<span class="org-rainbow-delimiters-depth-1">(</span>X, sample_weight<span class="org-operator">=</span>sample_weight<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">return</span> <span class="org-keyword">self</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">always return self!</span>

    <span class="org-keyword">def</span> <span class="org-function-name">transform</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, X<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">return</span> rbf_kernel<span class="org-rainbow-delimiters-depth-1">(</span>X, <span class="org-keyword">self</span>.kmeans_.cluster_centers_, gamma<span class="org-operator">=</span><span class="org-keyword">self</span>.gamma<span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-keyword">def</span> <span class="org-function-name">get_feature_names_out</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, names<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-1">[</span>f<span class="org-string">"Cluster </span>{i}<span class="org-string"> similarity"</span> <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">self</span>.n_clusters<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org6e206d5"><span class="org-variable-name">cluster_simil</span> <span class="org-operator">=</span> ClusterSimilarity<span class="org-rainbow-delimiters-depth-1">(</span>n_clusters<span class="org-operator">=</span>10, gamma<span class="org-operator">=</span>1., random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">similarities</span> <span class="org-operator">=</span> cluster_simil.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"latitude"</span>, <span class="org-string">"longitude"</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>,
                                           sample_weight<span class="org-operator">=</span>housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org305e036">similarities<span class="org-rainbow-delimiters-depth-1">[</span>:3<span class="org-rainbow-delimiters-depth-1">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span>2<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orge43f682"><span class="org-variable-name">housing_renamed</span> <span class="org-operator">=</span> housing.rename<span class="org-rainbow-delimiters-depth-1">(</span>columns<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-string">"latitude"</span>: <span class="org-string">"Latitude"</span>, <span class="org-string">"longitude"</span>: <span class="org-string">"Longitude"</span>,
    <span class="org-string">"population"</span>: <span class="org-string">"Population"</span>,
    <span class="org-string">"median_house_value"</span>: <span class="org-string">"Median house value (&#7452;s&#7429;)"</span><span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">housing_renamed</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"Max cluster similarity"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> similarities.<span class="org-builtin">max</span><span class="org-rainbow-delimiters-depth-1">(</span>axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>

housing_renamed.plot<span class="org-rainbow-delimiters-depth-1">(</span>kind<span class="org-operator">=</span><span class="org-string">"scatter"</span>, x<span class="org-operator">=</span><span class="org-string">"Longitude"</span>, y<span class="org-operator">=</span><span class="org-string">"Latitude"</span>, grid<span class="org-operator">=</span><span class="org-constant">True</span>,
                     s<span class="org-operator">=</span>housing_renamed<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"Population"</span><span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> 100, label<span class="org-operator">=</span><span class="org-string">"Population"</span>,
                     c<span class="org-operator">=</span><span class="org-string">"Max cluster similarity"</span>,
                     cmap<span class="org-operator">=</span><span class="org-string">"jet"</span>, colorbar<span class="org-operator">=</span><span class="org-constant">True</span>,
                     legend<span class="org-operator">=</span><span class="org-constant">True</span>, sharex<span class="org-operator">=</span><span class="org-constant">False</span>, figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>10, 7<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.plot<span class="org-rainbow-delimiters-depth-1">(</span>cluster_simil.kmeans_.cluster_centers_<span class="org-rainbow-delimiters-depth-2">[</span>:, 1<span class="org-rainbow-delimiters-depth-2">]</span>,
         cluster_simil.kmeans_.cluster_centers_<span class="org-rainbow-delimiters-depth-2">[</span>:, 0<span class="org-rainbow-delimiters-depth-2">]</span>,
         linestyle<span class="org-operator">=</span><span class="org-string">""</span>, color<span class="org-operator">=</span><span class="org-string">"black"</span>, marker<span class="org-operator">=</span><span class="org-string">"X"</span>, markersize<span class="org-operator">=</span>20,
         label<span class="org-operator">=</span><span class="org-string">"Cluster centers"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">(</span>loc<span class="org-operator">=</span><span class="org-string">"upper right"</span><span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"district-cluster-plot"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="orgc74f574" class="figure">
<p><img src="images/End-to-End-ML-Project/district-cluster-plot.png" alt="district-cluster-plot.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org4182010" class="outline-3">
<h3 id="org4182010">Transformation Pipelines</h3>
<div class="outline-text-3" id="text-org4182010">
<p>
Now let's build a pipeline to preprocess the numerical attributes:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb3ee32a"><span class="org-keyword">from</span> sklearn.pipeline <span class="org-keyword">import</span> Pipeline

<span class="org-variable-name">num_pipeline</span> <span class="org-operator">=</span> Pipeline<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"impute"</span>, SimpleImputer<span class="org-rainbow-delimiters-depth-4">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"standardize"</span>, StandardScaler<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>,
<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orga8f0eda"><span class="org-keyword">from</span> sklearn.pipeline <span class="org-keyword">import</span> make_pipeline

<span class="org-variable-name">num_pipeline</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>SimpleImputer<span class="org-rainbow-delimiters-depth-2">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-2">)</span>, StandardScaler<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org4fb720f"><span class="org-keyword">from</span> sklearn <span class="org-keyword">import</span> set_config

set_config<span class="org-rainbow-delimiters-depth-1">(</span>display<span class="org-operator">=</span><span class="org-string">'diagram'</span><span class="org-rainbow-delimiters-depth-1">)</span>

num_pipeline
</pre>
</div>

<pre class="example" id="orgbb9ce84">
Pipeline(steps=[('simpleimputer', SimpleImputer(strategy='median')),
                ('standardscaler', StandardScaler())])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org892f705"><span class="org-variable-name">housing_num_prepared</span> <span class="org-operator">=</span> num_pipeline.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing_num<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_num_prepared<span class="org-rainbow-delimiters-depth-2">[</span>:2<span class="org-rainbow-delimiters-depth-2">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-2">(</span>2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgbf663b5">
[[-1.42  1.01  1.86  0.31  1.37  0.14  1.39 -0.94]
 [ 0.6  -0.7   0.91 -0.31 -0.44 -0.69 -0.37  1.17]]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge9b9681"><span class="org-keyword">def</span> <span class="org-function-name">monkey_patch_get_signature_names_out</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-doc">"""Monkey patch some classes which did not handle get_feature_names_out()</span>
<span class="org-doc">       correctly in Scikit-Learn 1.0.*."""</span>
    <span class="org-keyword">from</span> inspect <span class="org-keyword">import</span> Signature, signature, Parameter
    <span class="org-keyword">import</span> pandas <span class="org-keyword">as</span> pd
    <span class="org-keyword">from</span> sklearn.impute <span class="org-keyword">import</span> SimpleImputer
    <span class="org-keyword">from</span> sklearn.pipeline <span class="org-keyword">import</span> make_pipeline, Pipeline
    <span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> FunctionTransformer, StandardScaler

    <span class="org-variable-name">default_get_feature_names_out</span> <span class="org-operator">=</span> StandardScaler.get_feature_names_out

    <span class="org-keyword">if</span> <span class="org-keyword">not</span> <span class="org-builtin">hasattr</span><span class="org-rainbow-delimiters-depth-1">(</span>SimpleImputer, <span class="org-string">"get_feature_names_out"</span><span class="org-rainbow-delimiters-depth-1">)</span>:
      <span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Monkey-patching SimpleImputer.get_feature_names_out()"</span><span class="org-rainbow-delimiters-depth-1">)</span>
      SimpleImputer.<span class="org-variable-name">get_feature_names_out</span> <span class="org-operator">=</span> default_get_feature_names_out

    <span class="org-keyword">if</span> <span class="org-keyword">not</span> <span class="org-builtin">hasattr</span><span class="org-rainbow-delimiters-depth-1">(</span>FunctionTransformer, <span class="org-string">"get_feature_names_out"</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Monkey-patching FunctionTransformer.get_feature_names_out()"</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">orig_init</span> <span class="org-operator">=</span> FunctionTransformer.__init__
        <span class="org-variable-name">orig_sig</span> <span class="org-operator">=</span> signature<span class="org-rainbow-delimiters-depth-1">(</span>orig_init<span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">*</span>args, feature_names_out<span class="org-operator">=</span><span class="org-constant">None</span>, <span class="org-operator">**</span>kwargs<span class="org-rainbow-delimiters-depth-1">)</span>:
            orig_sig.bind<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">*</span>args, <span class="org-operator">**</span>kwargs<span class="org-rainbow-delimiters-depth-1">)</span>
            orig_init<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">*</span>args, <span class="org-operator">**</span>kwargs<span class="org-rainbow-delimiters-depth-1">)</span>
            args<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.feature_names_out <span class="org-operator">=</span> feature_names_out

        __init__.<span class="org-variable-name">__signature__</span> <span class="org-operator">=</span> Signature<span class="org-rainbow-delimiters-depth-1">(</span>
            <span class="org-builtin">list</span><span class="org-rainbow-delimiters-depth-2">(</span>signature<span class="org-rainbow-delimiters-depth-3">(</span>orig_init<span class="org-rainbow-delimiters-depth-3">)</span>.parameters.values<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">+</span> <span class="org-rainbow-delimiters-depth-2">[</span>
                Parameter<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"feature_names_out"</span>, Parameter.KEYWORD_ONLY<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-keyword">def</span> <span class="org-function-name">get_feature_names_out</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, names<span class="org-operator">=</span><span class="org-constant">None</span><span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-keyword">if</span> <span class="org-builtin">callable</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>.feature_names_out<span class="org-rainbow-delimiters-depth-1">)</span>:
                <span class="org-keyword">return</span> <span class="org-keyword">self</span>.feature_names_out<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, names<span class="org-rainbow-delimiters-depth-1">)</span>
            <span class="org-keyword">assert</span> <span class="org-keyword">self</span>.feature_names_out <span class="org-operator">==</span> <span class="org-string">"one-to-one"</span>
            <span class="org-keyword">return</span> default_get_feature_names_out<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, names<span class="org-rainbow-delimiters-depth-1">)</span>

        FunctionTransformer.<span class="org-variable-name">__init__</span> <span class="org-operator">=</span> __init__
        FunctionTransformer.<span class="org-variable-name">get_feature_names_out</span> <span class="org-operator">=</span> get_feature_names_out

monkey_patch_get_signature_names_out<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org405d69c"><span class="org-variable-name">df_housing_num_prepared</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>
    housing_num_prepared, columns<span class="org-operator">=</span>num_pipeline.get_feature_names_out<span class="org-rainbow-delimiters-depth-2">()</span>,
    index<span class="org-operator">=</span>housing_num.index<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org69959bb">df_housing_num_prepared.head<span class="org-rainbow-delimiters-depth-1">(</span>2<span class="org-rainbow-delimiters-depth-1">)</span>  
</pre>
</div>

<pre class="example" id="org9430e60">
       longitude  latitude  housing_median_age  total_rooms  total_bedrooms  population  households  median_income
13096  -1.423037  1.013606            1.861119     0.311912        1.368167    0.137460    1.394812      -0.936491
14973   0.596394 -0.702103            0.907630    -0.308620       -0.435925   -0.693771   -0.373485       1.171942
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org46d2ed6"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>num_pipeline.steps<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgba2f603">
[('simpleimputer', SimpleImputer(strategy='median')), ('standardscaler', StandardScaler())]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgb9fb1f9">num_pipeline<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<pre class="example" id="org9824ba0">
StandardScaler()
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org8547b00">num_pipeline<span class="org-rainbow-delimiters-depth-1">[</span>:<span class="org-operator">-</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<pre class="example" id="org13a9046">
Pipeline(steps=[('simpleimputer', SimpleImputer(strategy='median'))])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org353dc5a">num_pipeline.named_steps<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"simpleimputer"</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<pre class="example" id="org6ced5d8">
SimpleImputer(strategy='median')
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org9dd6ccd">num_pipeline.set_params<span class="org-rainbow-delimiters-depth-1">(</span>simpleimputer__strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org62a73c4">
Pipeline(steps=[('simpleimputer', SimpleImputer(strategy='median')),
                ('standardscaler', StandardScaler())])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge8f128a"><span class="org-keyword">from</span> sklearn.compose <span class="org-keyword">import</span> ColumnTransformer

<span class="org-variable-name">num_attribs</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"longitude"</span>, <span class="org-string">"latitude"</span>, <span class="org-string">"housing_median_age"</span>, <span class="org-string">"total_rooms"</span>,
               <span class="org-string">"total_bedrooms"</span>, <span class="org-string">"population"</span>, <span class="org-string">"households"</span>, <span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">cat_attribs</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"ocean_proximity"</span><span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-variable-name">cat_pipeline</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>
    SimpleImputer<span class="org-rainbow-delimiters-depth-2">(</span>strategy<span class="org-operator">=</span><span class="org-string">"most_frequent"</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    OneHotEncoder<span class="org-rainbow-delimiters-depth-2">(</span>handle_unknown<span class="org-operator">=</span><span class="org-string">"ignore"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">preprocessing</span> <span class="org-operator">=</span> ColumnTransformer<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"num"</span>, num_pipeline, num_attribs<span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"cat"</span>, cat_pipeline, cat_attribs<span class="org-rainbow-delimiters-depth-3">)</span>,
<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org0f1b8f5"><span class="org-keyword">from</span> sklearn.compose <span class="org-keyword">import</span> make_column_selector, make_column_transformer

<span class="org-variable-name">preprocessing</span> <span class="org-operator">=</span> make_column_transformer<span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-rainbow-delimiters-depth-2">(</span>num_pipeline, make_column_selector<span class="org-rainbow-delimiters-depth-3">(</span>dtype_include<span class="org-operator">=</span>np.number<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    <span class="org-rainbow-delimiters-depth-2">(</span>cat_pipeline, make_column_selector<span class="org-rainbow-delimiters-depth-3">(</span>dtype_include<span class="org-operator">=</span><span class="org-builtin">object</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>,
<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org79a81cc"><span class="org-variable-name">housing_prepared</span> <span class="org-operator">=</span> preprocessing.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org517f659"><span class="org-variable-name">housing_prepared_fr</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>
    housing_prepared,
    columns<span class="org-operator">=</span>preprocessing.get_feature_names_out<span class="org-rainbow-delimiters-depth-2">()</span>,
    index<span class="org-operator">=</span>housing.index<span class="org-rainbow-delimiters-depth-1">)</span>
housing_prepared_fr.head<span class="org-rainbow-delimiters-depth-1">(</span>2<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org61739c2">
       pipeline-1__longitude  pipeline-1__latitude  pipeline-1__housing_median_age  ...  pipeline-2__ocean_proximity_ISLAND  pipeline-2__ocean_proximity_NEAR BAY  pipeline-2__ocean_proximity_NEAR OCEAN
13096              -1.423037              1.013606                        1.861119  ...                                 0.0                                   1.0                                     0.0
14973               0.596394             -0.702103                        0.907630  ...                                 0.0                                   0.0                                     0.0

[2 rows x 13 columns]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org6c515e7"><span class="org-keyword">def</span> <span class="org-function-name">column_ratio</span><span class="org-rainbow-delimiters-depth-1">(</span>X<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">return</span> X<span class="org-rainbow-delimiters-depth-1">[</span>:, <span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">/</span> X<span class="org-rainbow-delimiters-depth-1">[</span>:, <span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-keyword">def</span> <span class="org-function-name">ratio_name</span><span class="org-rainbow-delimiters-depth-1">(</span>function_transformer, feature_names_in<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"ratio"</span><span class="org-rainbow-delimiters-depth-1">]</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">feature names out</span>

<span class="org-keyword">def</span> <span class="org-function-name">ratio_pipeline</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-keyword">return</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>
        SimpleImputer<span class="org-rainbow-delimiters-depth-2">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-2">)</span>,
        FunctionTransformer<span class="org-rainbow-delimiters-depth-2">(</span>column_ratio, feature_names_out<span class="org-operator">=</span>ratio_name<span class="org-rainbow-delimiters-depth-2">)</span>,
        StandardScaler<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">log_pipeline</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>
    SimpleImputer<span class="org-rainbow-delimiters-depth-2">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    FunctionTransformer<span class="org-rainbow-delimiters-depth-2">(</span>np.log, feature_names_out<span class="org-operator">=</span><span class="org-string">"one-to-one"</span><span class="org-rainbow-delimiters-depth-2">)</span>,
    StandardScaler<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cluster_simil</span> <span class="org-operator">=</span> ClusterSimilarity<span class="org-rainbow-delimiters-depth-1">(</span>n_clusters<span class="org-operator">=</span>10, gamma<span class="org-operator">=</span>1., random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">default_num_pipeline</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>SimpleImputer<span class="org-rainbow-delimiters-depth-2">(</span>strategy<span class="org-operator">=</span><span class="org-string">"median"</span><span class="org-rainbow-delimiters-depth-2">)</span>,
                                     StandardScaler<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">preprocessing</span> <span class="org-operator">=</span> ColumnTransformer<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"bedrooms"</span>, ratio_pipeline<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"total_bedrooms"</span>, <span class="org-string">"total_rooms"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>,
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"rooms_per_house"</span>, ratio_pipeline<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"total_rooms"</span>, <span class="org-string">"households"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>,
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"people_per_house"</span>, ratio_pipeline<span class="org-rainbow-delimiters-depth-4">()</span>, <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"population"</span>, <span class="org-string">"households"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>,
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"log"</span>, log_pipeline, <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"total_bedrooms"</span>, <span class="org-string">"total_rooms"</span>, <span class="org-string">"population"</span>,
                               <span class="org-string">"households"</span>, <span class="org-string">"median_income"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>,
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"geo"</span>, cluster_simil, <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"latitude"</span>, <span class="org-string">"longitude"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>,
        <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"cat"</span>, cat_pipeline, make_column_selector<span class="org-rainbow-delimiters-depth-4">(</span>dtype_include<span class="org-operator">=</span><span class="org-builtin">object</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-rainbow-delimiters-depth-2">]</span>,
    remainder<span class="org-operator">=</span>default_num_pipeline<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">one column remaining: housing_median_age</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orga4f39d6"><span class="org-variable-name">housing_prepared</span> <span class="org-operator">=</span> preprocessing.fit_transform<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_prepared.shape<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org2627c21">
(16512, 24)
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgc49cba4"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>preprocessing.get_feature_names_out<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgab73dac">
['bedrooms__ratio' 'rooms_per_house__ratio' 'people_per_house__ratio'
 'log__total_bedrooms' 'log__total_rooms' 'log__population'
 'log__households' 'log__median_income' 'geo__Cluster 0 similarity'
 'geo__Cluster 1 similarity' 'geo__Cluster 2 similarity'
 'geo__Cluster 3 similarity' 'geo__Cluster 4 similarity'
 'geo__Cluster 5 similarity' 'geo__Cluster 6 similarity'
 'geo__Cluster 7 similarity' 'geo__Cluster 8 similarity'
 'geo__Cluster 9 similarity' 'cat__ocean_proximity_&lt;1H OCEAN'
 'cat__ocean_proximity_INLAND' 'cat__ocean_proximity_ISLAND'
 'cat__ocean_proximity_NEAR BAY' 'cat__ocean_proximity_NEAR OCEAN'
 'remainder__housing_median_age']
</pre>
</div>
</div>
</div>

<div id="outline-container-org7afd8db" class="outline-2">
<h2 id="org7afd8db">Select and Train a Model</h2>
<div class="outline-text-2" id="text-org7afd8db">
</div>
<div id="outline-container-orgd8aecd0" class="outline-3">
<h3 id="orgd8aecd0">Training and Evaluating on the Training Set</h3>
<div class="outline-text-3" id="text-orgd8aecd0">
<div class="org-src-container">
<pre class="src src-python" id="org8decbd6"><span class="org-keyword">from</span> sklearn.linear_model <span class="org-keyword">import</span> LinearRegression

<span class="org-variable-name">lin_reg</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>preprocessing, LinearRegression<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>lin_reg.fit<span class="org-rainbow-delimiters-depth-2">(</span>housing, housing_labels<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc7571f2">
Pipeline(steps=[('columntransformer',
                 ColumnTransformer(remainder=Pipeline(steps=[('simpleimputer',
                                                              SimpleImputer(strategy='median')),
                                                             ('standardscaler',
                                                              StandardScaler())]),
                                   transformers=[('bedrooms',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='median')),
                                                                  ('functiontransformer',
                                                                   FunctionTransformer(feature_names_out=&lt;function ratio_name at 0x17a...
                                                   'households',
                                                   'median_income']),                         ('geo',
                                                  ClusterSimilarity(random_state=42),
                                                  ['latitude', 'longitude']),
                                                 ('cat',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='most_frequent')),
                                                                  ('onehotencoder',
                                                                   OneHotEncoder(handle_unknown='ignore'))]),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x13a30dfa0&gt;)])),
                ('linearregression', LinearRegression())])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org3be1540"><span class="org-variable-name">housing_predictions</span> <span class="org-operator">=</span> lin_reg.predict<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_predictions<span class="org-rainbow-delimiters-depth-2">[</span>:5<span class="org-rainbow-delimiters-depth-2">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-operator">-</span>2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">-2 = rounded to the nearest hundred</span>
</pre>
</div>

<pre class="example" id="orgfa344e1">
[242800. 375900. 127500.  99400. 324600.]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgb710631"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>housing_labels.iloc<span class="org-rainbow-delimiters-depth-2">[</span>:5<span class="org-rainbow-delimiters-depth-2">]</span>.values<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orged55479">
[458300. 483800. 101700.  96100. 361800.]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org4971d19"><span class="org-variable-name">error_ratios</span> <span class="org-operator">=</span> housing_predictions<span class="org-rainbow-delimiters-depth-1">[</span>:5<span class="org-rainbow-delimiters-depth-1">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">-</span>2<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">/</span> housing_labels.iloc<span class="org-rainbow-delimiters-depth-1">[</span>:5<span class="org-rainbow-delimiters-depth-1">]</span>.values <span class="org-operator">-</span> 1
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">", "</span>.join<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>f<span class="org-string">"</span>{100 <span class="org-operator">*</span> ratio:.1f}<span class="org-string">%"</span> <span class="org-keyword">for</span> ratio <span class="org-keyword">in</span> error_ratios<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org62f10f2">
-47.0%, -22.3%, 25.4%, 3.4%, -10.3%
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgd0830e8"><span class="org-keyword">from</span> sklearn.metrics <span class="org-keyword">import</span> mean_squared_error

<span class="org-variable-name">lin_rmse</span> <span class="org-operator">=</span> mean_squared_error<span class="org-rainbow-delimiters-depth-1">(</span>housing_labels, housing_predictions,
                              squared<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
lin_rmse
</pre>
</div>

<pre class="example" id="orgb3aec4f">
68647.95686706656
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org605f8c3"><span class="org-keyword">from</span> sklearn.tree <span class="org-keyword">import</span> DecisionTreeRegressor

<span class="org-variable-name">tree_reg</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>preprocessing, DecisionTreeRegressor<span class="org-rainbow-delimiters-depth-2">(</span>random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
tree_reg.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing, housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org6d718b3">
Pipeline(steps=[('columntransformer',
                 ColumnTransformer(remainder=Pipeline(steps=[('simpleimputer',
                                                              SimpleImputer(strategy='median')),
                                                             ('standardscaler',
                                                              StandardScaler())]),
                                   transformers=[('bedrooms',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='median')),
                                                                  ('functiontransformer',
                                                                   FunctionTransformer(feature_names_out=&lt;function ratio_name at 0x17a...
                                                 ('geo',
                                                  ClusterSimilarity(random_state=42),
                                                  ['latitude', 'longitude']),
                                                 ('cat',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='most_frequent')),
                                                                  ('onehotencoder',
                                                                   OneHotEncoder(handle_unknown='ignore'))]),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x13a30dfa0&gt;)])),
                ('decisiontreeregressor',
                 DecisionTreeRegressor(random_state=42))])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgae77d87"><span class="org-variable-name">housing_predictions</span> <span class="org-operator">=</span> tree_reg.predict<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">tree_rmse</span> <span class="org-operator">=</span> mean_squared_error<span class="org-rainbow-delimiters-depth-1">(</span>housing_labels, housing_predictions,
                              squared<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
tree_rmse
</pre>
</div>

<pre class="example" id="org1ed1c93">
0.0
</pre>
</div>
</div>

<div id="outline-container-orgde567af" class="outline-3">
<h3 id="orgde567af">Better Evaluation using Cross-Validation</h3>
<div class="outline-text-3" id="text-orgde567af">
<div class="org-src-container">
<pre class="src src-python" id="org91fcdff"><span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> cross_val_score

<span class="org-variable-name">tree_rmses</span> <span class="org-operator">=</span> <span class="org-operator">-</span>cross_val_score<span class="org-rainbow-delimiters-depth-1">(</span>tree_reg, housing, housing_labels,
                              scoring<span class="org-operator">=</span><span class="org-string">"neg_root_mean_squared_error"</span>, cv<span class="org-operator">=</span>10<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org5e12d11">pd.Series<span class="org-rainbow-delimiters-depth-1">(</span>tree_rmses<span class="org-rainbow-delimiters-depth-1">)</span>.describe<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="orgf75fcba">
count       10.000000
mean     67153.318273
std       1963.580924
min      63925.253106
25%      66083.277180
50%      66795.829871
75%      68074.018403
max      70664.635833
dtype: float64
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge83c868"><span class="org-variable-name">lin_rmses</span> <span class="org-operator">=</span> <span class="org-operator">-</span>cross_val_score<span class="org-rainbow-delimiters-depth-1">(</span>lin_reg, housing, housing_labels,
                              scoring<span class="org-operator">=</span><span class="org-string">"neg_root_mean_squared_error"</span>, cv<span class="org-operator">=</span>10<span class="org-rainbow-delimiters-depth-1">)</span>
pd.Series<span class="org-rainbow-delimiters-depth-1">(</span>lin_rmses<span class="org-rainbow-delimiters-depth-1">)</span>.describe<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="orga2b52c8">
count       10.000000
mean     69847.923224
std       4078.407329
min      65659.761079
25%      68088.799156
50%      68697.591463
75%      69800.966364
max      80685.254832
dtype: float64
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orge460b17"><span class="org-keyword">from</span> sklearn.ensemble <span class="org-keyword">import</span> RandomForestRegressor

<span class="org-variable-name">forest_reg</span> <span class="org-operator">=</span> make_pipeline<span class="org-rainbow-delimiters-depth-1">(</span>preprocessing,
                           RandomForestRegressor<span class="org-rainbow-delimiters-depth-2">(</span>random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">forest_rmses</span> <span class="org-operator">=</span> <span class="org-operator">-</span>cross_val_score<span class="org-rainbow-delimiters-depth-1">(</span>forest_reg, housing, housing_labels,
                                scoring<span class="org-operator">=</span><span class="org-string">"neg_root_mean_squared_error"</span>, cv<span class="org-operator">=</span>10<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org948d75e">pd.Series<span class="org-rainbow-delimiters-depth-1">(</span>forest_rmses<span class="org-rainbow-delimiters-depth-1">)</span>.describe<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org0901aa5">
count       10.000000
mean     47002.931706
std       1048.451340
min      45667.064036
25%      46494.358345
50%      47093.173938
75%      47274.873814
max      49354.705514
dtype: float64
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org4d65e6e">forest_reg.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing, housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">housing_predictions</span> <span class="org-operator">=</span> forest_reg.predict<span class="org-rainbow-delimiters-depth-1">(</span>housing<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">forest_rmse</span> <span class="org-operator">=</span> mean_squared_error<span class="org-rainbow-delimiters-depth-1">(</span>housing_labels, housing_predictions,
                                 squared<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
forest_rmse
</pre>
</div>

<pre class="example" id="org9f99db3">
17547.52124624957
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f5333d" class="outline-2">
<h2 id="org9f5333d">Fine-Tuning the Model</h2>
<div class="outline-text-2" id="text-org9f5333d">
</div>
<div id="outline-container-org0ea896b" class="outline-3">
<h3 id="org0ea896b">Using Grid Search</h3>
<div class="outline-text-3" id="text-org0ea896b">
<div class="org-src-container">
<pre class="src src-python" id="org11ff91f"><span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> GridSearchCV

<span class="org-variable-name">full_pipeline</span> <span class="org-operator">=</span> Pipeline<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"preprocessing"</span>, preprocessing<span class="org-rainbow-delimiters-depth-3">)</span>,
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"random_forest"</span>, RandomForestRegressor<span class="org-rainbow-delimiters-depth-4">(</span>random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>,
<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">param_grid</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span>
    <span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">'preprocessing__geo__n_clusters'</span>: <span class="org-rainbow-delimiters-depth-3">[</span>5, 8, 10<span class="org-rainbow-delimiters-depth-3">]</span>,
     <span class="org-string">'random_forest__max_features'</span>: <span class="org-rainbow-delimiters-depth-3">[</span>4, 6, 8<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span>,
    <span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">'preprocessing__geo__n_clusters'</span>: <span class="org-rainbow-delimiters-depth-3">[</span>10, 15<span class="org-rainbow-delimiters-depth-3">]</span>,
     <span class="org-string">'random_forest__max_features'</span>: <span class="org-rainbow-delimiters-depth-3">[</span>6, 8, 10<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span>,
<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">grid_search</span> <span class="org-operator">=</span> GridSearchCV<span class="org-rainbow-delimiters-depth-1">(</span>full_pipeline, param_grid, cv<span class="org-operator">=</span>3,
                           scoring<span class="org-operator">=</span><span class="org-string">'neg_root_mean_squared_error'</span><span class="org-rainbow-delimiters-depth-1">)</span>
grid_search.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing, housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org7607a52">
GridSearchCV(cv=3,
             estimator=Pipeline(steps=[('preprocessing',
                                        ColumnTransformer(remainder=Pipeline(steps=[('simpleimputer',
                                                                                     SimpleImputer(strategy='median')),
                                                                                    ('standardscaler',
                                                                                     StandardScaler())]),
                                                          transformers=[('bedrooms',
                                                                         Pipeline(steps=[('simpleimputer',
                                                                                          SimpleImputer(strategy='median')),
                                                                                         ('functiontransformer',
                                                                                          FunctionTransformer(feature_names_out=&lt;f...
                                                                         &lt;sklearn.compose._column_transformer.make_column_selector object at 0x13a30dfa0&gt;)])),
                                       ('random_forest',
                                        RandomForestRegressor(random_state=42))]),
             param_grid=[{'preprocessing__geo__n_clusters': [5, 8, 10],
                          'random_forest__max_features': [4, 6, 8]},
                         {'preprocessing__geo__n_clusters': [10, 15],
                          'random_forest__max_features': [6, 8, 10]}],
             scoring='neg_root_mean_squared_error')
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org4f2fdd2"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">str</span><span class="org-rainbow-delimiters-depth-2">(</span>full_pipeline.get_params<span class="org-rainbow-delimiters-depth-3">()</span>.keys<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)[</span>:1000<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">+</span> <span class="org-string">"..."</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org8ad1894">
dict_keys(['memory', 'steps', 'verbose', 'preprocessing', 'random_forest', 'preprocessing__force_int_remainder_cols', 'preprocessing__n_jobs', 'preprocessing__remainder__memory', 'preprocessing__remainder__steps', 'preprocessing__remainder__verbose', 'preprocessing__remainder__simpleimputer', 'preprocessing__remainder__standardscaler', 'preprocessing__remainder__simpleimputer__add_indicator', 'preprocessing__remainder__simpleimputer__copy', 'preprocessing__remainder__simpleimputer__fill_value', 'preprocessing__remainder__simpleimputer__keep_empty_features', 'preprocessing__remainder__simpleimputer__missing_values', 'preprocessing__remainder__simpleimputer__strategy', 'preprocessing__remainder__standardscaler__copy', 'preprocessing__remainder__standardscaler__with_mean', 'preprocessing__remainder__standardscaler__with_std', 'preprocessing__remainder', 'preprocessing__sparse_threshold', 'preprocessing__transformer_weights', 'preprocessing__transformers', 'preprocessing__verbose', 'prepro...
</pre>


<div class="org-src-container">
<pre class="src src-python" id="org51e9fbc"><span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>grid_search.best_params_<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org314322d">
{'preprocessing__geo__n_clusters': 15, 'random_forest__max_features': 6}
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org26cea95">grid_search.best_estimator_
</pre>
</div>

<pre class="example" id="orga5a5d01">
Pipeline(steps=[('preprocessing',
                 ColumnTransformer(remainder=Pipeline(steps=[('simpleimputer',
                                                              SimpleImputer(strategy='median')),
                                                             ('standardscaler',
                                                              StandardScaler())]),
                                   transformers=[('bedrooms',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='median')),
                                                                  ('functiontransformer',
                                                                   FunctionTransformer(feature_names_out=&lt;function ratio_name at 0x17ab813...
                                                  ClusterSimilarity(n_clusters=15,
                                                                    random_state=42),
                                                  ['latitude', 'longitude']),
                                                 ('cat',
                                                  Pipeline(steps=[('simpleimputer',
                                                                   SimpleImputer(strategy='most_frequent')),
                                                                  ('onehotencoder',
                                                                   OneHotEncoder(handle_unknown='ignore'))]),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x13a4b54c0&gt;)])),
                ('random_forest',
                 RandomForestRegressor(max_features=6, random_state=42))])
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org1dd37e9"><span class="org-variable-name">cv_res</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>grid_search.cv_results_<span class="org-rainbow-delimiters-depth-1">)</span>
cv_res.sort_values<span class="org-rainbow-delimiters-depth-1">(</span>by<span class="org-operator">=</span><span class="org-string">"mean_test_score"</span>, ascending<span class="org-operator">=</span><span class="org-constant">False</span>, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">extra code &#8211; these few lines of code just make the DataFrame look nicer</span>
<span class="org-variable-name">cv_res</span> <span class="org-operator">=</span> cv_res<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"param_preprocessing__geo__n_clusters"</span>,
                 <span class="org-string">"param_random_forest__max_features"</span>, <span class="org-string">"split0_test_score"</span>,
                 <span class="org-string">"split1_test_score"</span>, <span class="org-string">"split2_test_score"</span>, <span class="org-string">"mean_test_score"</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">score_cols</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"split0"</span>, <span class="org-string">"split1"</span>, <span class="org-string">"split2"</span>, <span class="org-string">"mean_test_rmse"</span><span class="org-rainbow-delimiters-depth-1">]</span>
cv_res.<span class="org-variable-name">columns</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"n_clusters"</span>, <span class="org-string">"max_features"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+</span> score_cols
<span class="org-variable-name">cv_res</span><span class="org-rainbow-delimiters-depth-1">[</span>score_cols<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> <span class="org-operator">-</span>cv_res<span class="org-rainbow-delimiters-depth-1">[</span>score_cols<span class="org-rainbow-delimiters-depth-1">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">()</span>.astype<span class="org-rainbow-delimiters-depth-1">(</span>np.int64<span class="org-rainbow-delimiters-depth-1">)</span>

cv_res.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org3681332">
    n_clusters  max_features  split0  split1  split2  mean_test_rmse
12          15             6   43536   43759   44568           43954
13          15             8   44084   44205   44863           44384
14          15            10   44368   44496   45200           44688
7           10             6   44252   44628   45857           44912
9           10             6   44252   44628   45857           44912
</pre>
</div>
</div>

<div id="outline-container-org231f28e" class="outline-3">
<h3 id="org231f28e">Randomised Search</h3>
<div class="outline-text-3" id="text-org231f28e">
<div class="org-src-container">
<pre class="src src-python" id="org35dac90"><span class="org-keyword">from</span> sklearn.experimental <span class="org-keyword">import</span> enable_halving_search_cv
<span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> HalvingRandomSearchCV
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgf6339e4"><span class="org-keyword">from</span> sklearn.model_selection <span class="org-keyword">import</span> RandomizedSearchCV
<span class="org-keyword">from</span> scipy.stats <span class="org-keyword">import</span> randint

<span class="org-variable-name">param_distribs</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">{</span><span class="org-string">'preprocessing__geo__n_clusters'</span>: randint<span class="org-rainbow-delimiters-depth-2">(</span>low<span class="org-operator">=</span>3, high<span class="org-operator">=</span>50<span class="org-rainbow-delimiters-depth-2">)</span>,
                  <span class="org-string">'random_forest__max_features'</span>: randint<span class="org-rainbow-delimiters-depth-2">(</span>low<span class="org-operator">=</span>2, high<span class="org-operator">=</span>20<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-variable-name">rnd_search</span> <span class="org-operator">=</span> RandomizedSearchCV<span class="org-rainbow-delimiters-depth-1">(</span>
    full_pipeline, param_distributions<span class="org-operator">=</span>param_distribs, n_iter<span class="org-operator">=</span>10, cv<span class="org-operator">=</span>3,
    scoring<span class="org-operator">=</span><span class="org-string">'neg_root_mean_squared_error'</span>, random_state<span class="org-operator">=</span>42<span class="org-rainbow-delimiters-depth-1">)</span>

rnd_search.fit<span class="org-rainbow-delimiters-depth-1">(</span>housing, housing_labels<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org164957a">
RandomizedSearchCV(cv=3,
                   estimator=Pipeline(steps=[('preprocessing',
                                              ColumnTransformer(remainder=Pipeline(steps=[('simpleimputer',
                                                                                           SimpleImputer(strategy='median')),
                                                                                          ('standardscaler',
                                                                                           StandardScaler())]),
                                                                transformers=[('bedrooms',
                                                                               Pipeline(steps=[('simpleimputer',
                                                                                                SimpleImputer(strategy='median')),
                                                                                               ('functiontransformer',
                                                                                                FunctionTransformer(feature_names_...
                                                                               &lt;sklearn.compose._column_transformer.make_column_selector object at 0x13a30dfa0&gt;)])),
                                             ('random_forest',
                                              RandomForestRegressor(random_state=42))]),
                   param_distributions={'preprocessing__geo__n_clusters': &lt;scipy.stats._distn_infrastructure.rv_discrete_frozen object at 0x13e206240&gt;,
                                        'random_forest__max_features': &lt;scipy.stats._distn_infrastructure.rv_discrete_frozen object at 0x13a447650&gt;},
                   random_state=42, scoring='neg_root_mean_squared_error')
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org582480d"><span class="org-variable-name">cv_res</span> <span class="org-operator">=</span> pd.DataFrame<span class="org-rainbow-delimiters-depth-1">(</span>rnd_search.cv_results_<span class="org-rainbow-delimiters-depth-1">)</span>
cv_res.sort_values<span class="org-rainbow-delimiters-depth-1">(</span>by<span class="org-operator">=</span><span class="org-string">"mean_test_score"</span>, ascending<span class="org-operator">=</span><span class="org-constant">False</span>, inplace<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cv_res</span> <span class="org-operator">=</span> cv_res<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"param_preprocessing__geo__n_clusters"</span>,
                 <span class="org-string">"param_random_forest__max_features"</span>, <span class="org-string">"split0_test_score"</span>,
                 <span class="org-string">"split1_test_score"</span>, <span class="org-string">"split2_test_score"</span>, <span class="org-string">"mean_test_score"</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>
cv_res.<span class="org-variable-name">columns</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"n_clusters"</span>, <span class="org-string">"max_features"</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+</span> score_cols
<span class="org-variable-name">cv_res</span><span class="org-rainbow-delimiters-depth-1">[</span>score_cols<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> <span class="org-operator">-</span>cv_res<span class="org-rainbow-delimiters-depth-1">[</span>score_cols<span class="org-rainbow-delimiters-depth-1">]</span>.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">()</span>.astype<span class="org-rainbow-delimiters-depth-1">(</span>np.int64<span class="org-rainbow-delimiters-depth-1">)</span>
cv_res.head<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<pre class="example" id="org47631a7">
   n_clusters  max_features  split0  split1  split2  mean_test_rmse
1          45             9   41099   42150   42701           41983
8          32             7   41604   42200   43219           42341
5          42             4   41798   42967   43536           42767
0          41            16   42106   42743   43459           42769
2          23             8   42422   43108   43832           43121
</pre>

<div class="org-src-container">
<pre class="src src-python" id="orgef4b7c4"><span class="org-keyword">from</span> scipy.stats <span class="org-keyword">import</span> randint, uniform, geom, expon

<span class="org-variable-name">xs1</span> <span class="org-operator">=</span> np.arange<span class="org-rainbow-delimiters-depth-1">(</span>0, 7 <span class="org-operator">+</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">randint_distrib</span> <span class="org-operator">=</span> randint<span class="org-rainbow-delimiters-depth-1">(</span>0, 7 <span class="org-operator">+</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>.pmf<span class="org-rainbow-delimiters-depth-1">(</span>xs1<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">xs2</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>0, 7, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">uniform_distrib</span> <span class="org-operator">=</span> uniform<span class="org-rainbow-delimiters-depth-1">(</span>0, 7<span class="org-rainbow-delimiters-depth-1">)</span>.pdf<span class="org-rainbow-delimiters-depth-1">(</span>xs2<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">xs3</span> <span class="org-operator">=</span> np.arange<span class="org-rainbow-delimiters-depth-1">(</span>0, 7 <span class="org-operator">+</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">geom_distrib</span> <span class="org-operator">=</span> geom<span class="org-rainbow-delimiters-depth-1">(</span>0.5<span class="org-rainbow-delimiters-depth-1">)</span>.pmf<span class="org-rainbow-delimiters-depth-1">(</span>xs3<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">xs4</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>0, 7, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">expon_distrib</span> <span class="org-operator">=</span> expon<span class="org-rainbow-delimiters-depth-1">(</span>scale<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>.pdf<span class="org-rainbow-delimiters-depth-1">(</span>xs4<span class="org-rainbow-delimiters-depth-1">)</span>

plt.figure<span class="org-rainbow-delimiters-depth-1">(</span>figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>12, 7<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 1<span class="org-rainbow-delimiters-depth-1">)</span>
plt.bar<span class="org-rainbow-delimiters-depth-1">(</span>xs1, randint_distrib, label<span class="org-operator">=</span><span class="org-string">"scipy.randint(0, 7 + 1)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Probability"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-operator">-</span>1, 8, 0, 0.2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 2<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>xs2, uniform_distrib, label<span class="org-operator">=</span><span class="org-string">"scipy.uniform(0, 7)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"PDF"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-operator">-</span>1, 8, 0, 0.2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 3<span class="org-rainbow-delimiters-depth-1">)</span>
plt.bar<span class="org-rainbow-delimiters-depth-1">(</span>xs3, geom_distrib, label<span class="org-operator">=</span><span class="org-string">"scipy.geom(0.5)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Hyperparameter value"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Probability"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>0, 7, 0, 1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 4<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>xs4, expon_distrib, label<span class="org-operator">=</span><span class="org-string">"scipy.expon(scale=1)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Hyperparameter value"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"PDF"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>0, 7, 0, 1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"choosing-sampling"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>


<div id="org67b7b5c" class="figure">
<p><img src="images/End-to-End-ML-Project/choosing-sampling.png" alt="choosing-sampling.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org1ef004e"><span class="org-keyword">from</span> scipy.stats <span class="org-keyword">import</span> loguniform

<span class="org-variable-name">xs1</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>0, 7, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">expon_distrib</span> <span class="org-operator">=</span> expon<span class="org-rainbow-delimiters-depth-1">(</span>scale<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>.pdf<span class="org-rainbow-delimiters-depth-1">(</span>xs1<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">log_xs2</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-operator">-</span>5, 3, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">log_expon_distrib</span> <span class="org-operator">=</span> np.exp<span class="org-rainbow-delimiters-depth-1">(</span>log_xs2 <span class="org-operator">-</span> np.exp<span class="org-rainbow-delimiters-depth-2">(</span>log_xs2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">xs3</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>0.001, 1000, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">loguniform_distrib</span> <span class="org-operator">=</span> loguniform<span class="org-rainbow-delimiters-depth-1">(</span>0.001, 1000<span class="org-rainbow-delimiters-depth-1">)</span>.pdf<span class="org-rainbow-delimiters-depth-1">(</span>xs3<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">log_xs4</span> <span class="org-operator">=</span> np.linspace<span class="org-rainbow-delimiters-depth-1">(</span>np.log<span class="org-rainbow-delimiters-depth-2">(</span>0.001<span class="org-rainbow-delimiters-depth-2">)</span>, np.log<span class="org-rainbow-delimiters-depth-2">(</span>1000<span class="org-rainbow-delimiters-depth-2">)</span>, 500<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">log_loguniform_distrib</span> <span class="org-operator">=</span> uniform<span class="org-rainbow-delimiters-depth-1">(</span>np.log<span class="org-rainbow-delimiters-depth-2">(</span>0.001<span class="org-rainbow-delimiters-depth-2">)</span>, np.log<span class="org-rainbow-delimiters-depth-2">(</span>1000<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>.pdf<span class="org-rainbow-delimiters-depth-1">(</span>log_xs4<span class="org-rainbow-delimiters-depth-1">)</span>

plt.figure<span class="org-rainbow-delimiters-depth-1">(</span>figsize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>12, 7<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 1<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>xs1, expon_distrib,
                 label<span class="org-operator">=</span><span class="org-string">"scipy.expon(scale=1)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"PDF"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>0, 7, 0, 1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 2<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>log_xs2, log_expon_distrib,
                 label<span class="org-operator">=</span><span class="org-string">"log(X) with X ~ expon"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-operator">-</span>5, 3, 0, 1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 3<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>xs3, loguniform_distrib,
                 label<span class="org-operator">=</span><span class="org-string">"scipy.loguniform(0.001, 1000)"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Hyperparameter value"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.ylabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"PDF"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span>0.001, 1000, 0, 0.005<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

plt.subplot<span class="org-rainbow-delimiters-depth-1">(</span>2, 2, 4<span class="org-rainbow-delimiters-depth-1">)</span>
plt.fill_between<span class="org-rainbow-delimiters-depth-1">(</span>log_xs4, log_loguniform_distrib,
                 label<span class="org-operator">=</span><span class="org-string">"log(X) with X ~ loguniform"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.xlabel<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Log of hyperparameter value"</span><span class="org-rainbow-delimiters-depth-1">)</span>
plt.legend<span class="org-rainbow-delimiters-depth-1">()</span>
plt.axis<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-operator">-</span>8, 1, 0, 0.2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"choosing-sampling-2"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org7e61402" class="figure">
<p><img src="images/End-to-End-ML-Project/choosing-sampling-2.png" alt="choosing-sampling-2.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgd6cdd18" class="outline-3">
<h3 id="orgd6cdd18">Analyse the Best Models and Errors</h3>
<div class="outline-text-3" id="text-orgd6cdd18">
<div class="org-src-container">
<pre class="src src-python" id="org8dea212"><span class="org-variable-name">final_model</span> <span class="org-operator">=</span> rnd_search.best_estimator_  <span class="org-comment-delimiter"># </span><span class="org-comment">includes preprocessing</span>
<span class="org-variable-name">feature_importances</span> <span class="org-operator">=</span> final_model<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"random_forest"</span><span class="org-rainbow-delimiters-depth-1">]</span>.feature_importances_
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>feature_importances.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-2">(</span>2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgc230115">
[0.06 0.06 0.05 0.01 0.01 0.01 0.01 0.19 0.01 0.01 0.02 0.04 0.01 0.
 0.02 0.01 0.01 0.01 0.01 0.01 0.   0.   0.01 0.   0.01 0.02 0.02 0.01
 0.01 0.01 0.03 0.01 0.01 0.01 0.01 0.01 0.01 0.   0.01 0.01 0.02 0.01
 0.01 0.01 0.01 0.01 0.01 0.01 0.02 0.01 0.01 0.01 0.01 0.   0.08 0.
 0.   0.   0.01]
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org9fef280"><span class="org-builtin">sorted</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">zip</span><span class="org-rainbow-delimiters-depth-2">(</span>feature_importances,
           final_model<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"preprocessing"</span><span class="org-rainbow-delimiters-depth-3">]</span>.get_feature_names_out<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>,
           reverse<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">0.19087378222226137</td>
<td class="org-left">log_<sub>median</sub><sub>income</sub></td>
</tr>

<tr>
<td class="org-right">0.07625632853052883</td>
<td class="org-left">cat_<sub>ocean</sub><sub>proximity</sub><sub>INLAND</sub></td>
</tr>

<tr>
<td class="org-right">0.06365028932207333</td>
<td class="org-left">bedrooms_<sub>ratio</sub></td>
</tr>

<tr>
<td class="org-right">0.057834740538722625</td>
<td class="org-left">rooms<sub>per</sub><sub>house</sub>_<sub>ratio</sub></td>
</tr>

<tr>
<td class="org-right">0.04907003277818634</td>
<td class="org-left">people<sub>per</sub><sub>house</sub>_<sub>ratio</sub></td>
</tr>

<tr>
<td class="org-right">0.038165489600129165</td>
<td class="org-left">geo_<sub>Cluster</sub> 3 similarity</td>
</tr>

<tr>
<td class="org-right">0.025700861301416925</td>
<td class="org-left">geo_<sub>Cluster</sub> 22 similarity</td>
</tr>

<tr>
<td class="org-right">0.02186407550147744</td>
<td class="org-left">geo_<sub>Cluster</sub> 17 similarity</td>
</tr>

<tr>
<td class="org-right">0.021818299311019237</td>
<td class="org-left">geo_<sub>Cluster</sub> 6 similarity</td>
</tr>

<tr>
<td class="org-right">0.018249904787654904</td>
<td class="org-left">geo_<sub>Cluster</sub> 2 similarity</td>
</tr>

<tr>
<td class="org-right">0.017263517651784216</td>
<td class="org-left">geo_<sub>Cluster</sub> 32 similarity</td>
</tr>

<tr>
<td class="org-right">0.015649725317935348</td>
<td class="org-left">geo_<sub>Cluster</sub> 18 similarity</td>
</tr>

<tr>
<td class="org-right">0.015236556682888558</td>
<td class="org-left">geo_<sub>Cluster</sub> 40 similarity</td>
</tr>

<tr>
<td class="org-right">0.014160249342841777</td>
<td class="org-left">geo_<sub>Cluster</sub> 43 similarity</td>
</tr>

<tr>
<td class="org-right">0.014113856232349186</td>
<td class="org-left">geo_<sub>Cluster</sub> 7 similarity</td>
</tr>

<tr>
<td class="org-right">0.013968406769681294</td>
<td class="org-left">geo_<sub>Cluster</sub> 21 similarity</td>
</tr>

<tr>
<td class="org-right">0.013781633271007265</td>
<td class="org-left">geo_<sub>Cluster</sub> 38 similarity</td>
</tr>

<tr>
<td class="org-right">0.013515022744382842</td>
<td class="org-left">geo_<sub>Cluster</sub> 34 similarity</td>
</tr>

<tr>
<td class="org-right">0.013508738042902313</td>
<td class="org-left">geo_<sub>Cluster</sub> 41 similarity</td>
</tr>

<tr>
<td class="org-right">0.012844820424121687</td>
<td class="org-left">geo_<sub>Cluster</sub> 24 similarity</td>
</tr>

<tr>
<td class="org-right">0.01236427981858226</td>
<td class="org-left">geo_<sub>Cluster</sub> 10 similarity</td>
</tr>

<tr>
<td class="org-right">0.01176408158393247</td>
<td class="org-left">remainder_<sub>housing</sub><sub>median</sub><sub>age</sub></td>
</tr>

<tr>
<td class="org-right">0.011436849025886087</td>
<td class="org-left">geo_<sub>Cluster</sub> 31 similarity</td>
</tr>

<tr>
<td class="org-right">0.011430032718708965</td>
<td class="org-left">geo_<sub>Cluster</sub> 30 similarity</td>
</tr>

<tr>
<td class="org-right">0.011262888671999243</td>
<td class="org-left">geo_<sub>Cluster</sub> 42 similarity</td>
</tr>

<tr>
<td class="org-right">0.011082126500672662</td>
<td class="org-left">geo_<sub>Cluster</sub> 16 similarity</td>
</tr>

<tr>
<td class="org-right">0.01087991522984511</td>
<td class="org-left">geo_<sub>Cluster</sub> 1 similarity</td>
</tr>

<tr>
<td class="org-right">0.0106352262787596</td>
<td class="org-left">geo_<sub>Cluster</sub> 25 similarity</td>
</tr>

<tr>
<td class="org-right">0.010629636976156976</td>
<td class="org-left">geo_<sub>Cluster</sub> 26 similarity</td>
</tr>

<tr>
<td class="org-right">0.010325438106958176</td>
<td class="org-left">geo_<sub>Cluster</sub> 20 similarity</td>
</tr>

<tr>
<td class="org-right">0.009978597341631139</td>
<td class="org-left">geo_<sub>Cluster</sub> 35 similarity</td>
</tr>

<tr>
<td class="org-right">0.009811902116084414</td>
<td class="org-left">geo_<sub>Cluster</sub> 14 similarity</td>
</tr>

<tr>
<td class="org-right">0.00926835411026417</td>
<td class="org-left">geo_<sub>Cluster</sub> 39 similarity</td>
</tr>

<tr>
<td class="org-right">0.009210910491673824</td>
<td class="org-left">geo_<sub>Cluster</sub> 37 similarity</td>
</tr>

<tr>
<td class="org-right">0.008838219938405523</td>
<td class="org-left">geo_<sub>Cluster</sub> 0 similarity</td>
</tr>

<tr>
<td class="org-right">0.00883623406533351</td>
<td class="org-left">geo_<sub>Cluster</sub> 9 similarity</td>
</tr>

<tr>
<td class="org-right">0.008743931217845727</td>
<td class="org-left">geo_<sub>Cluster</sub> 8 similarity</td>
</tr>

<tr>
<td class="org-right">0.008563362393325231</td>
<td class="org-left">geo_<sub>Cluster</sub> 36 similarity</td>
</tr>

<tr>
<td class="org-right">0.008465719960196051</td>
<td class="org-left">geo_<sub>Cluster</sub> 28 similarity</td>
</tr>

<tr>
<td class="org-right">0.008001576292023282</td>
<td class="org-left">geo_<sub>Cluster</sub> 44 similarity</td>
</tr>

<tr>
<td class="org-right">0.007942690751495287</td>
<td class="org-left">geo_<sub>Cluster</sub> 4 similarity</td>
</tr>

<tr>
<td class="org-right">0.00792848112158647</td>
<td class="org-left">geo_<sub>Cluster</sub> 11 similarity</td>
</tr>

<tr>
<td class="org-right">0.007724755678419276</td>
<td class="org-left">log_<sub>total</sub><sub>rooms</sub></td>
</tr>

<tr>
<td class="org-right">0.0071161520040372486</td>
<td class="org-left">log_<sub>population</sub></td>
</tr>

<tr>
<td class="org-right">0.006792638958967365</td>
<td class="org-left">log_<sub>total</sub><sub>bedrooms</sub></td>
</tr>

<tr>
<td class="org-right">0.006504955481581277</td>
<td class="org-left">log_<sub>households</sub></td>
</tr>

<tr>
<td class="org-right">0.006215189140929538</td>
<td class="org-left">geo_<sub>Cluster</sub> 23 similarity</td>
</tr>

<tr>
<td class="org-right">0.0056299034599644185</td>
<td class="org-left">geo_<sub>Cluster</sub> 19 similarity</td>
</tr>

<tr>
<td class="org-right">0.005544728303210014</td>
<td class="org-left">geo_<sub>Cluster</sub> 27 similarity</td>
</tr>

<tr>
<td class="org-right">0.00526201040506395</td>
<td class="org-left">geo_<sub>Cluster</sub> 33 similarity</td>
</tr>

<tr>
<td class="org-right">0.004834036365364593</td>
<td class="org-left">geo_<sub>Cluster</sub> 15 similarity</td>
</tr>

<tr>
<td class="org-right">0.004177160622478634</td>
<td class="org-left">geo_<sub>Cluster</sub> 12 similarity</td>
</tr>

<tr>
<td class="org-right">0.0040378619656822245</td>
<td class="org-left">geo_<sub>Cluster</sub> 13 similarity</td>
</tr>

<tr>
<td class="org-right">0.0036513301086410445</td>
<td class="org-left">geo_<sub>Cluster</sub> 29 similarity</td>
</tr>

<tr>
<td class="org-right">0.0033595680753400604</td>
<td class="org-left">cat_<sub>ocean</sub><sub>proximity</sub>_&lt;1H OCEAN</td>
</tr>

<tr>
<td class="org-right">0.001969988014822343</td>
<td class="org-left">geo_<sub>Cluster</sub> 5 similarity</td>
</tr>

<tr>
<td class="org-right">0.001955486511135513</td>
<td class="org-left">cat_<sub>ocean</sub><sub>proximity</sub><sub>NEAR</sub> OCEAN</td>
</tr>

<tr>
<td class="org-right">0.0002362031046240973</td>
<td class="org-left">cat_<sub>ocean</sub><sub>proximity</sub><sub>NEAR</sub> BAY</td>
</tr>

<tr>
<td class="org-right">6.124671500751693e-05</td>
<td class="org-left">cat_<sub>ocean</sub><sub>proximity</sub><sub>ISLAND</sub></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org5006d1d" class="outline-3">
<h3 id="org5006d1d">Evaluate using the Test Set</h3>
<div class="outline-text-3" id="text-org5006d1d">
<p>
Time to evaluate the model with the test set:
</p>

<ol class="org-ol">
<li>get the predictors and the labels from the test set,</li>
<li>run <span class="Code">final_mode</span> to transform data,</li>
<li>make predictions,</li>
<li>evaluate the predictions.</li>
</ol>

<div class="org-src-container">
<pre class="src src-python" id="org6d39763"><span class="org-variable-name">X_test</span> <span class="org-operator">=</span> strat_test_set.drop<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"median_house_value"</span>, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">y_test</span> <span class="org-operator">=</span> strat_test_set<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-string">"median_house_value"</span><span class="org-rainbow-delimiters-depth-1">]</span>.copy<span class="org-rainbow-delimiters-depth-1">()</span>

<span class="org-variable-name">final_predictions</span> <span class="org-operator">=</span> final_model.predict<span class="org-rainbow-delimiters-depth-1">(</span>X_test<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">final_rmse</span> <span class="org-operator">=</span> mean_squared_error<span class="org-rainbow-delimiters-depth-1">(</span>y_test, final_predictions, squared<span class="org-operator">=</span><span class="org-constant">False</span><span class="org-rainbow-delimiters-depth-1">)</span>
final_rmse
</pre>
</div>

<pre class="example" id="orgc1127ba">
41536.20954091729
</pre>

<p>
We need to know <span class="Hlight">How good is the model</span>. For this, compute
the %95 <a href="https://en.wikipedia.org/wiki/Confidence_interval">confidence interval</a> for the generalisation error using
<span class="Code">scipy.stats.t.interval()</span>.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org25fb53a"><span class="org-keyword">from</span> scipy <span class="org-keyword">import</span> stats

<span class="org-variable-name">confidence</span> <span class="org-operator">=</span> 0.95
<span class="org-variable-name">squared_errors</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span>final_predictions <span class="org-operator">-</span> y_test<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">**</span> 2
<span class="org-variable-name">result</span><span class="org-operator">=</span> np.sqrt<span class="org-rainbow-delimiters-depth-1">(</span>stats.t.interval<span class="org-rainbow-delimiters-depth-2">(</span>confidence, <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-3">(</span>squared_errors<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-operator">-</span> 1,
                         loc<span class="org-operator">=</span>squared_errors.mean<span class="org-rainbow-delimiters-depth-3">()</span>,
                         scale<span class="org-operator">=</span>stats.sem<span class="org-rainbow-delimiters-depth-3">(</span>squared_errors<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>result<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="org217f082">
[39391.51194455 43575.47696556]
</pre>

<p>
The value is roughly in the middle of it.
</p>

<p>
There are <span class="Hlight">different</span> ways of calculating it as well.
</p>

<p>
Below is the manual way of writing the confidence interval.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org56932fd"><span class="org-variable-name">m</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>squared_errors<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">mean</span> <span class="org-operator">=</span> squared_errors.mean<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-variable-name">tscore</span> <span class="org-operator">=</span> stats.t.ppf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>1 <span class="org-operator">+</span> confidence<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> 2, df<span class="org-operator">=</span>m <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">tmargin</span> <span class="org-operator">=</span> tscore <span class="org-operator">*</span> squared_errors.std<span class="org-rainbow-delimiters-depth-1">(</span>ddof<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">/</span> np.sqrt<span class="org-rainbow-delimiters-depth-1">(</span>m<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>np.sqrt<span class="org-rainbow-delimiters-depth-2">(</span>mean <span class="org-operator">-</span> tmargin<span class="org-rainbow-delimiters-depth-2">)</span>, np.sqrt<span class="org-rainbow-delimiters-depth-2">(</span>mean <span class="org-operator">+</span> tmargin<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgeabdb66">
39391.51194455236 43575.476965561335
</pre>

<p>
Alternatively, we can use z-score (i.e., <a href="https://en.wikipedia.org/wiki/Standard_score">Standard score</a>) to calculate as the
data set is relatively big.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgc364aac"><span class="org-variable-name">zscore</span> <span class="org-operator">=</span> stats.norm.ppf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>1 <span class="org-operator">+</span> confidence<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> 2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">zmargin</span> <span class="org-operator">=</span> zscore <span class="org-operator">*</span> squared_errors.std<span class="org-rainbow-delimiters-depth-1">(</span>ddof<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">/</span> np.sqrt<span class="org-rainbow-delimiters-depth-1">(</span>m<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>np.sqrt<span class="org-rainbow-delimiters-depth-2">(</span>mean <span class="org-operator">-</span> zmargin<span class="org-rainbow-delimiters-depth-2">)</span>, np.sqrt<span class="org-rainbow-delimiters-depth-2">(</span>mean <span class="org-operator">+</span> zmargin<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgbd841c3">
39392.15805502188 43574.89288365666
</pre>

<p>
<span class="Note">NOTE:</span> Doing a lot of hyperparameter tuning can make the model behave worse as
it would be highly tuned to the train data and may not be as performant as on test data.
</p>
</div>
</div>

<div id="outline-container-org3dcab0f" class="outline-3">
<h3 id="org3dcab0f">Saving the Model</h3>
<div class="outline-text-3" id="text-org3dcab0f">
<p>
Time to get the model into production and the easiest way to do is to <span class="Hlight">save the best model</span>.
</p>

<p>
To save it, you can use the <span class="Code">joblib</span> module <a href="https://joblib.readthedocs.io/en/stable/">[More Info]â€‹</a>, which allows pipelining. 
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf87a092"><span class="org-keyword">import</span> joblib

joblib.dump<span class="org-rainbow-delimiters-depth-1">(</span>final_model, <span class="org-string">"my_california_housing_model.pkl"</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Once saved, you can load and use it, with all the <span class="Hlight">necessary dependencies loaded</span>.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgd9a31a2"><span class="org-keyword">import</span> joblib

<span class="org-comment-delimiter"># </span><span class="org-comment">extra code &#8211; excluded for conciseness</span>
<span class="org-keyword">from</span> sklearn.cluster <span class="org-keyword">import</span> KMeans
<span class="org-keyword">from</span> sklearn.base <span class="org-keyword">import</span> BaseEstimator, TransformerMixin
<span class="org-keyword">from</span> sklearn.metrics.pairwise <span class="org-keyword">import</span> rbf_kernel

<span class="org-keyword">def</span> <span class="org-function-name">column_ratio</span><span class="org-rainbow-delimiters-depth-1">(</span>X<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">return</span> X<span class="org-rainbow-delimiters-depth-1">[</span>:, <span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">/</span> X<span class="org-rainbow-delimiters-depth-1">[</span>:, <span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">class ClusterSimilarity(BaseEstimator, TransformerMixin):</span>
<span class="org-comment-delimiter">#    </span><span class="org-comment">[...]</span>

<span class="org-variable-name">final_model_reloaded</span> <span class="org-operator">=</span> joblib.load<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"my_california_housing_model.pkl"</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">new_data</span> <span class="org-operator">=</span> housing.iloc<span class="org-rainbow-delimiters-depth-1">[</span>:5<span class="org-rainbow-delimiters-depth-1">]</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">pretend these are new districts</span>
<span class="org-variable-name">predictions</span> <span class="org-operator">=</span> final_model_reloaded.predict<span class="org-rainbow-delimiters-depth-1">(</span>new_data<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>predictions<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example" id="orgdbcb3a0">
[441558.14 455211.06 109319.    98208.   338068.04]
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Daniel McGuiness</p>
</div>
</body>
</html>
